# This test plan checks some high-level behavior of the repokit CLI.
# But also serves as unittests for the features supported by the YAML parser.

# Output the version of the CLI.
- # Test single parameter provided as a string.
  cli_parameters: --version
  # Test providing floating-point numbers to timeout.
  timeout: 80.0
  exit_code: 0
  stdout_contains: ", version"
  # yamllint disable-line rule:line-length
  stdout_regex_fullmatch: "\x1b\\[97mrepokit\x1b\\[0m, version \x1b\\[32m[0-9]+\\.[0-9]+\\.[0-9]+(\\.[a-z]+[0-9]+(\\+[a-f0-9]+)?)?\x1b\\[0m\n"


# Test combination of version and verbosity.
- cli_parameters:
    # Test parameters provided as a list of strings.
    - --verbosity
    - DEBUG
    - --version
  exit_code: 0
  stdout_contains: ", version"
  stdout_regex_matches: "\x1b\\[97mrepokit\x1b\\[0m, version "
  stderr_contains:
    - "Set <RootLogger root (DEBUG)> to DEBUG."
    - "\x1b[34mdebug\x1b[0m: {prog_name}      : \x1b[97mrepokit\x1b[0m\n"
  stderr_regex_matches:
    - "\x1b\\[34mdebug\x1b\\[0m: {prog_name}      : \x1b\\[97mrepokit\x1b\\[0m\n"


# Test help output.
- cli_parameters:
    - --help
  strip_ansi: true
  stdout_contains:
    - "Usage: repokit [OPTIONS] COMMAND [ARGS]..."
    - "-h, --help"


# Test metadata output.
- cli_parameters: --verbosity INFO metadata
  # XXX This command fail on Windows as it try to print emojis to the console, from the source changelog:
  # UnicodeEncodeError: 'charmap' codec can't encode character '\U0001f64f' in position 39913: character maps
  # to <undefined>
  skip_platforms: windows
  stderr_contains:
    - "info: Print metadata to <stdout>"
  # Note: new_commits and new_commits_matrix are empty locally, but contain
  # commit SHAs when running in GitHub Actions CI. Use stdout_contains for key
  # checks instead of fullmatch since release_notes content varies.
  stdout_contains:
    - "mailmap_exists=true"
    - "is_python_project=true"
    - "package_name=repokit"
    - "is_sphinx=false"
  stdout_regex_matches:
    - "is_bot=(true|false)"
    - "skip_binary_build=(true|false)"
    - "new_commits=([a-f0-9]+)?"
    - "release_commits=([a-f0-9]+)?"
    - 'python_files="[\S ]+"'
    - "current_version=[0-9.]+(\\.[a-z]+[0-9]+)?"
    - "release_notes<<GHA_DELIMITER_[0-9]+"
    - "GHA_DELIMITER_[0-9]+"
    - "build_targets=\\[\\{\"target\": .+\\}\\]"
    - "nuitka_matrix=\\{\"os\": \\[.+\\]"
    - "minor_bump_allowed=(true|false)"
    - "major_bump_allowed=(true|false)"

# Test changelog output.
- cli_parameters:
    - --verbosity
    - INFO
    - changelog
  # XXX This command fail on Windows as it try to print emojis to the console, from the source changelog:
  # UnicodeEncodeError: 'charmap' codec can't encode character '\U0001f64f' in position 39913: character maps
  # to <undefined>
  skip_platforms: Windows
  stdout_regex_fullmatch: |-
    # Changelog

    ## \[`[0-9\.]+(\.dev[0-9]+)?` \(unreleased\)\]\(https://github.com/kdeldycke/repokit/compare/v[0-9\.]+\.\.\.main\)

    > \[\!WARNING\]
    > This version is \*\*not released yet\*\* and is under active development\.

    .+


# Test sync-mailmap output.
- cli_parameters:
    - --verbosity
    - INFO
    - sync-mailmap
  only_platforms:
    # Test mixed-case platform names, provided as a list of strings.
    - linux
    - macOS
    - windows
  exit_code: 0
  stderr_regex_matches:
    - "info: Read initial mapping from \\S+\\.mailmap"
    - "info: (Save updated results to|Print updated results to)"


# Test test-plan output.
- cli_parameters:
    - --verbosity
    - INFO
    - test-plan
  exit_code: 2
  strip_ansi: true
  # Test multi-line single string.
  stderr_contains: |
    Usage: repokit test-plan [OPTIONS]
    Try 'repokit test-plan --help' for help.

    Error: Missing option '--command' / '--binary'.
