---
name: ü™Ñ Autofix
"on":
  workflow_call:
    secrets:
      WORKFLOW_UPDATE_GITHUB_PAT:
        required: false
  workflow_dispatch:
  push:
    branches:
      - main

env:
  HAS_WORKFLOW_PAT: ${{ secrets.WORKFLOW_UPDATE_GITHUB_PAT && 'true' || '' }}

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: ${{ !startsWith(github.event.head_commit.message, '[changelog] Release') }}

jobs:

  setup-guide:
    name: üìñ Setup guide
    # Only run on push to the default branch, not on workflow_call from downstream.
    # Skip on the upstream repo itself (it already has the secret).
    if: github.event_name == 'push' && github.repository != 'kdeldycke/repomatic'
    runs-on: ubuntu-slim
    permissions:
      issues: write
    steps:
      - uses: actions/checkout@v6.0.2
      - uses: astral-sh/setup-uv@v7.3.0
      - name: Manage setup guide issue
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: uvx --no-progress --from . repomatic setup-guide

  project-metadata:
    name: üß¨ Project metadata
    runs-on: ubuntu-slim
    outputs:
      gitignore_exists: ${{ steps.project-metadata.outputs.gitignore_exists }}
      python_files: ${{ steps.project-metadata.outputs.python_files }}
      json_files: ${{ steps.project-metadata.outputs.json_files }}
      doc_files: ${{ steps.project-metadata.outputs.doc_files }}
      markdown_files: ${{ steps.project-metadata.outputs.markdown_files }}
      is_python_project: ${{ steps.project-metadata.outputs.is_python_project }}
      mailmap_exists: ${{ steps.project-metadata.outputs.mailmap_exists }}
      renovate_config_exists: ${{ steps.project-metadata.outputs.renovate_config_exists }}
      image_files: ${{ steps.project-metadata.outputs.image_files }}
      active_autodoc: ${{ steps.project-metadata.outputs.active_autodoc }}
      release_commits_matrix: ${{ steps.project-metadata.outputs.release_commits_matrix }}
    steps:
      - uses: actions/checkout@v6.0.2
      - uses: astral-sh/setup-uv@v7.3.0
      - name: Run repomatic metadata
        id: project-metadata
        run: uvx --no-progress --from . repomatic metadata --output "$GITHUB_OUTPUT"

  # --- Formatters: rewrite files to enforce canonical style. ---

  format-python:
    name: üêç Format Python
    needs:
      - project-metadata
    # Ruff can format code in both Python and Markdown files.
    if: needs.project-metadata.outputs.python_files || needs.project-metadata.outputs.doc_files
    runs-on: ubuntu-slim
    steps:
      - uses: actions/checkout@v6.0.2
      - uses: astral-sh/setup-uv@v7.3.0
      - name: Run autopep8
        if: needs.project-metadata.outputs.python_files
        # Ruff is not wrapping comments: https://github.com/astral-sh/ruff/issues/7414
        # We use autopep8 to only wrap long-line comments:
        #  - E501 is "Try to make lines fit within --max-line-length characters."
        #  - --aggressive is requires to force autopep8 to consider comments.
        # Explicit list of files is provided, as autopep8 is not able to handle find files in ".github" subdirectory.
        run: >
          uvx --no-progress 'autopep8==2.3.2' --recursive --in-place --max-line-length 88 --select E501 --aggressive
          ${{ needs.project-metadata.outputs.python_files }}
      - name: Install Ruff and init config
        # Initialize [tool.ruff] in pyproject.toml if it doesn't exist.
        # Projects with existing ruff config will keep their settings.
        run: |
          uv tool install 'ruff==0.15.1'
          uvx --no-progress --from . repomatic init ruff
      # XXX Ruff is planning to support linting and formatting in one unified command at one point.
      #     See: https://github.com/astral-sh/ruff/issues/8232
      - name: Run Ruff
        run: |
          ruff check --output-format github
          ruff format --output-format github
      - id: pr-metadata
        run: >
          uvx --no-progress --from . repomatic pr-body
          --template format-python
          --output "$GITHUB_OUTPUT"
      - uses: peter-evans/create-pull-request@v8.1.0
        with:
          assignees: ${{ github.actor }}
          commit-message: ${{ steps.pr-metadata.outputs.commit_message }}
          title: ${{ steps.pr-metadata.outputs.title }}
          body: ${{ steps.pr-metadata.outputs.body }}
          labels: "ü§ñ ci"
          branch: format-python

  format-pyproject:
    name: üìê Format pyproject.toml
    needs:
      - project-metadata
    if: fromJSON(needs.project-metadata.outputs.is_python_project)
    runs-on: ubuntu-slim
    steps:
      - uses: actions/checkout@v6.0.2
      - uses: astral-sh/setup-uv@v7.3.0
      - name: Run pyproject-fmt
        # pyproject-fmt returns exit code 1 when it reformats the file.
        # We ignore this since changes are expected in an autofix workflow.
        run: >
          uvx --no-progress 'pyproject-fmt==2.16.0'
          --expand-tables project.entry-points,project.optional-dependencies,project.urls,project.scripts
          pyproject.toml || true
      - id: pr-metadata
        run: >
          uvx --no-progress --from . repomatic pr-body
          --template format-pyproject
          --output "$GITHUB_OUTPUT"
      - uses: peter-evans/create-pull-request@v8.1.0
        with:
          assignees: ${{ github.actor }}
          commit-message: ${{ steps.pr-metadata.outputs.commit_message }}
          title: ${{ steps.pr-metadata.outputs.title }}
          body: ${{ steps.pr-metadata.outputs.body }}
          labels: "ü§ñ ci"
          branch: format-pyproject

  format-markdown:
    name: ‚úçÔ∏è Format Markdown
    needs:
      - project-metadata
    if: needs.project-metadata.outputs.markdown_files
    # Cannot use "ubuntu-slim" because shfmt is not available there.
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v6.0.2
      - uses: astral-sh/setup-uv@v7.3.0
      # https://mdformat.readthedocs.io/en/stable/users/plugins.html
      - name: Install mdformat
        # XXX mdformat-pelican is capped at mdformat<0.8.0 so it block the whole ecosystem from upgrading:
        # https://github.com/gaige/mdformat-pelican/pull/8
        run: >
          uv tool install
          --with 'mdformat_admon==2.1.1'
          --with 'mdformat-config==0.2.1'
          --with 'mdformat_deflist==0.1.4'
          --with 'mdformat_footnote==0.1.3'
          --with 'mdformat-front-matters==2.0.0'
          --with 'mdformat-gfm==1.0.0'
          --with 'mdformat_gfm_alerts==2.0.0'
          --with 'mdformat_myst==0.3.0'
          --with 'mdformat-pelican @ git+https://github.com/kdeldycke/mdformat-pelican@fix-mdformat-1.0.0'
          --with 'mdformat_pyproject==0.1.1'
          --with 'mdformat-recover-urls==0.0.2'
          --with 'mdformat-ruff==0.1.3'
          --with 'mdformat-shfmt==0.2.0'
          --with 'mdformat_simple_breaks==0.1.0'
          --with 'mdformat-toc==0.5.0'
          --with 'mdformat-web==0.2.0'
          --with 'ruff==0.15.1'
          'mdformat==1.0.0'
      - name: Install shfmt
        run: sudo apt install --yes shfmt
      - name: mdformat --version
        run: mdformat --version
      - name: Auto-format Markdown
        run: >
          for file in ${{ needs.project-metadata.outputs.markdown_files }}; do
          mdformat --number --strict-front-matter "$file";
          done
      - name: Markdown fixes for Awesome Lists
        if: startsWith(github.event.repository.name, 'awesome-')
        # Remove forbidden TOC entries: https://github.com/sindresorhus/awesome-lint/blob/v2.2.2/rules/toc.js#L14-L18
        # Also remove the title of the section containing the TOC (i.e. "Contents") to fix the following error:
        # ‚úñ  26:1  ToC item "Contents" does not match corresponding heading "Meta"  remark-lint:awesome-toc
        #
        # mdformat-toc has pending PRs to support this feature:
        # https://github.com/hukkin/mdformat-toc/issues/17
        # https://github.com/hukkin/mdformat-toc/pull/20
        run: >
          find ./ -type f \( -name 'readme.md' -or -name 'readme.*.md' \) -print
          -exec gawk -i inplace '!/^- \[(Contents|Contributing|Footnotes|Related Lists)\]\(#.+\)$/{print}' "{}" \;
      - id: pr-metadata
        run: >
          uvx --no-progress --from . repomatic pr-body
          --template format-markdown
          --output "$GITHUB_OUTPUT"
      - uses: peter-evans/create-pull-request@v8.1.0
        with:
          assignees: ${{ github.actor }}
          commit-message: ${{ steps.pr-metadata.outputs.commit_message }}
          title: ${{ steps.pr-metadata.outputs.title }}
          body: ${{ steps.pr-metadata.outputs.body }}
          labels: "üìö documentation"
          branch: format-markdown

  format-json:
    name: üîß Format JSON
    needs:
      - project-metadata
    if: needs.project-metadata.outputs.json_files
    runs-on: ubuntu-slim
    steps:
      - uses: actions/checkout@v6.0.2
      - uses: astral-sh/setup-uv@v7.3.0
      - name: Install Biome
        run: |
          curl -fsSL \
            "https://github.com/biomejs/biome/releases/download/%40biomejs%2Fbiome%402.3.15/biome-linux-x64" \
            --output /tmp/biome
          echo "ae6b986670a2384877a7fbfaf47509f9c46facfce9942a83000ee94ca534574d  /tmp/biome" | sha256sum --check
          install /tmp/biome /usr/local/bin/biome
      - name: Format JSON
        # Allow comments and trailing commas for JSONC files.
        # Biome auto-detects well-known JSONC files (tsconfig.json, etc.).
        run: >
          biome format --write
          --no-errors-on-unmatched
          --json-parse-allow-comments=true
          --json-parse-allow-trailing-commas=true
          ${{ needs.project-metadata.outputs.json_files }}
      - id: pr-metadata
        run: >
          uvx --no-progress --from . repomatic pr-body
          --template format-json
          --output "$GITHUB_OUTPUT"
      - uses: peter-evans/create-pull-request@v8.1.0
        with:
          assignees: ${{ github.actor }}
          commit-message: ${{ steps.pr-metadata.outputs.commit_message }}
          title: ${{ steps.pr-metadata.outputs.title }}
          body: ${{ steps.pr-metadata.outputs.body }}
          labels: "ü§ñ ci"
          branch: format-json

  # --- Fixers: correct or improve existing content in-place. ---

  fix-typos:
    name: ‚úèÔ∏è Fix typos
    runs-on: ubuntu-slim
    steps:
      - uses: actions/checkout@v6.0.2
      - uses: astral-sh/setup-uv@v7.3.0
      - name: Install typos
        run: |
          curl -fsSL --output /tmp/typos.tar.gz \
            "https://github.com/crate-ci/typos/releases/download/v1.43.4/typos-v1.43.4-x86_64-unknown-linux-musl.tar.gz"
          echo "f05f9da84ba714789271a2915060f8b7d329411b5c11e83b8d2c367ef592036c  /tmp/typos.tar.gz" | sha256sum --check
          tar xzf /tmp/typos.tar.gz -C /usr/local/bin ./typos
      - name: Fix typos
        run: typos --write-changes
      - id: pr-metadata
        run: >
          uvx --no-progress --from . repomatic pr-body
          --template fix-typos
          --output "$GITHUB_OUTPUT"
      - uses: peter-evans/create-pull-request@v8.1.0
        with:
          # We need custom PAT with workflows permissions to fix typos in .github/workflows/*.yaml` files.
          token: ${{ secrets.WORKFLOW_UPDATE_GITHUB_PAT || secrets.GITHUB_TOKEN }}
          assignees: ${{ github.actor }}
          commit-message: ${{ steps.pr-metadata.outputs.commit_message }}
          title: ${{ steps.pr-metadata.outputs.title }}
          body: ${{ steps.pr-metadata.outputs.body }}
          labels: "üìö documentation"
          branch: fix-typos
      - name: PAT setup hint
        if: failure() && !env.HAS_WORKFLOW_PAT
        run: >
          echo "::error::WORKFLOW_UPDATE_GITHUB_PAT is not configured.
          The default GITHUB_TOKEN cannot push changes to .github/workflows/ files.
          See ${{ github.server_url }}/${{ github.repository }}/issues?q=is:issue+WORKFLOW_UPDATE_GITHUB_PAT+in:title"

  fix-changelog:
    name: üìã Fix changelog
    needs:
      - project-metadata
    # Skip during release cycle. See repomatic/changelog.py lint_changelog_dates docstring.
    if: "!needs.project-metadata.outputs.release_commits_matrix"
    runs-on: ubuntu-slim
    steps:
      - uses: actions/checkout@v6.0.2
        with:
          fetch-tags: true
      - uses: astral-sh/setup-uv@v7.3.0
      - name: Fix changelog dates and admonitions
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: uvx --no-progress --from . repomatic lint-changelog --fix
      - id: pr-metadata
        run: >
          uvx --no-progress --from . repomatic pr-body
          --template fix-changelog
          --output "$GITHUB_OUTPUT"
      - uses: peter-evans/create-pull-request@v8.1.0
        with:
          assignees: ${{ github.actor }}
          commit-message: ${{ steps.pr-metadata.outputs.commit_message }}
          title: ${{ steps.pr-metadata.outputs.title }}
          body: ${{ steps.pr-metadata.outputs.body }}
          labels: "üÜô changelog"
          branch: fix-changelog

  optimize-images:
    name: üñºÔ∏è Optimize images
    needs:
      - project-metadata
    if: needs.project-metadata.outputs.image_files
    runs-on: ubuntu-slim
    steps:
      - uses: actions/checkout@v6.0.2
      - uses: astral-sh/setup-uv@v7.3.0
      - name: Install image optimization tools
        run: >
          sudo apt-get update &&
          sudo apt-get install --yes --no-install-recommends
          oxipng jpegoptim
      - name: Optimize images
        id: optimize
        run: >
          uvx --no-progress --from . repomatic optimize-images
          --output "$GITHUB_OUTPUT"
      - id: pr-metadata
        env:
          GHA_PR_BODY_PREFIX: ${{ steps.optimize.outputs.markdown }}
        run: uvx --no-progress --from . repomatic pr-body --output "$GITHUB_OUTPUT"
      - uses: peter-evans/create-pull-request@v8.1.0
        with:
          assignees: ${{ github.actor }}
          commit-message: Optimize images
          title: Optimize images
          body: ${{ steps.pr-metadata.outputs.body }}
          labels: "üìö documentation"
          branch: optimize-images

  # --- Syncers: regenerate files from external sources or project state. ---

  sync-gitignore:
    name: üôà Sync .gitignore
    needs:
      - project-metadata
    if: fromJSON(needs.project-metadata.outputs.gitignore_exists)
    runs-on: ubuntu-slim
    steps:
      - uses: actions/checkout@v6.0.2
      - uses: astral-sh/setup-uv@v7.3.0
      - name: Sync .gitignore
        run: uvx --no-progress --from . repomatic sync-gitignore
      - id: pr-metadata
        run: >
          uvx --no-progress --from . repomatic pr-body
          --template sync-gitignore
          --output "$GITHUB_OUTPUT"
      - uses: peter-evans/create-pull-request@v8.1.0
        with:
          assignees: ${{ github.actor }}
          commit-message: ${{ steps.pr-metadata.outputs.commit_message }}
          title: ${{ steps.pr-metadata.outputs.title }}
          body: ${{ steps.pr-metadata.outputs.body }}
          labels: "ü§ñ ci"
          branch: sync-gitignore

  sync-bumpversion:
    name: üîÑ Sync bumpversion config
    runs-on: ubuntu-slim
    steps:
      - uses: actions/checkout@v6.0.2
      - uses: astral-sh/setup-uv@v7.3.0
      - name: Sync bumpversion config
        run: uvx --no-progress --from . repomatic sync-bumpversion
      - id: pr-metadata
        run: >
          uvx --no-progress --from . repomatic pr-body
          --template sync-bumpversion
          --output "$GITHUB_OUTPUT"
      - uses: peter-evans/create-pull-request@v8.1.0
        with:
          assignees: ${{ github.actor }}
          commit-message: ${{ steps.pr-metadata.outputs.commit_message }}
          title: ${{ steps.pr-metadata.outputs.title }}
          body: ${{ steps.pr-metadata.outputs.body }}
          labels: "ü§ñ ci"
          branch: sync-bumpversion

  sync-linter-configs:
    name: üîÑ Sync linter configs
    runs-on: ubuntu-slim
    steps:
      - uses: actions/checkout@v6.0.2
      - uses: astral-sh/setup-uv@v7.3.0
      - name: Sync linter configs
        run: uvx --no-progress --from . repomatic sync-linter-configs
      - id: pr-metadata
        run: >
          uvx --no-progress --from . repomatic pr-body
          --template sync-linter-configs
          --output "$GITHUB_OUTPUT"
      - uses: peter-evans/create-pull-request@v8.1.0
        with:
          assignees: ${{ github.actor }}
          commit-message: ${{ steps.pr-metadata.outputs.commit_message }}
          title: ${{ steps.pr-metadata.outputs.title }}
          body: ${{ steps.pr-metadata.outputs.body }}
          labels: "ü§ñ ci"
          branch: sync-linter-configs

  sync-renovate:
    name: üîÑ Sync renovate.json5
    needs:
      - project-metadata
    if: >-
      github.repository != 'kdeldycke/repomatic'
      && fromJSON(needs.project-metadata.outputs.renovate_config_exists)
    runs-on: ubuntu-slim
    steps:
      - uses: actions/checkout@v6.0.2
      - uses: astral-sh/setup-uv@v7.3.0
      - name: Sync Renovate config
        run: uvx --no-progress --from . repomatic sync-renovate
      - id: pr-metadata
        run: >
          uvx --no-progress --from . repomatic pr-body
          --template sync-renovate
          --output "$GITHUB_OUTPUT"
      - uses: peter-evans/create-pull-request@v8.1.0
        with:
          assignees: ${{ github.actor }}
          commit-message: ${{ steps.pr-metadata.outputs.commit_message }}
          title: ${{ steps.pr-metadata.outputs.title }}
          body: ${{ steps.pr-metadata.outputs.body }}
          labels: "ü§ñ ci"
          branch: sync-renovate

  sync-mailmap:
    name: üì¨ Sync .mailmap
    needs:
      - project-metadata
    if: fromJSON(needs.project-metadata.outputs.mailmap_exists)
    runs-on: ubuntu-slim
    steps:
      - uses: actions/checkout@v6.0.2
        with:
          # Fetch all history to extract all contributors.
          fetch-depth: 0
      - uses: astral-sh/setup-uv@v7.3.0
      - name: Sync .mailmap
        run: uvx --no-progress --from . repomatic sync-mailmap --skip-if-missing
      - id: pr-metadata
        run: >
          uvx --no-progress --from . repomatic pr-body
          --template sync-mailmap
          --output "$GITHUB_OUTPUT"
      - uses: peter-evans/create-pull-request@v8.1.0
        with:
          assignees: ${{ github.actor }}
          commit-message: ${{ steps.pr-metadata.outputs.commit_message }}
          title: ${{ steps.pr-metadata.outputs.title }}
          body: ${{ steps.pr-metadata.outputs.body }}
          labels: "üìö documentation"
          branch: sync-mailmap

  update-deps-graph:
    name: üï∏Ô∏è Update dependency graph
    needs:
      - project-metadata
    # Only update dependency graph on release to avoid noise from transitive dependency changes.
    if: >
      fromJSON(needs.project-metadata.outputs.is_python_project)
      && needs.project-metadata.outputs.release_commits_matrix
    runs-on: ubuntu-slim
    steps:
      - uses: actions/checkout@v6.0.2
      - uses: astral-sh/setup-uv@v7.3.0
      - name: Generate graph
        # Package name and output path are auto-detected from pyproject.toml.
        run: uvx --no-progress --from . repomatic update-deps-graph
      - id: pr-metadata
        run: >
          uvx --no-progress --from . repomatic pr-body
          --template update-deps-graph
          --output "$GITHUB_OUTPUT"
      - uses: peter-evans/create-pull-request@v8.1.0
        with:
          assignees: ${{ github.actor }}
          commit-message: ${{ steps.pr-metadata.outputs.commit_message }}
          title: ${{ steps.pr-metadata.outputs.title }}
          body: ${{ steps.pr-metadata.outputs.body }}
          labels: "üìö documentation"
          branch: update-deps-graph

  update-docs:
    name: üìö Update docs
    needs:
      - project-metadata
    if: >
      fromJSON(needs.project-metadata.outputs.is_python_project)
      && fromJSON(needs.project-metadata.outputs.active_autodoc)
    runs-on: ubuntu-slim
    steps:
      - uses: actions/checkout@v6.0.2
      - uses: astral-sh/setup-uv@v7.3.0
      - name: Regenerate Sphinx autodoc
        # Omit --force so existing RST files (often with custom modifications produced by the next step) are preserved.
        # Only new module stubs are created, and deleted ones are left for manual removal by the maintainers.
        run: uv --no-progress run --frozen --group docs -- sphinx-apidoc --no-toc --module-first --output-dir ./docs .
      - name: Run docs update script
        # Run docs/docs_update.py if present to generate dynamic content (tables, diagrams, directives).
        run: |
          if [ -f docs/docs_update.py ]; then
            uv --no-progress run --frozen --group docs -- python docs/docs_update.py
          fi
      - id: pr-metadata
        run: >
          uvx --no-progress --from . repomatic pr-body
          --template update-docs
          --output "$GITHUB_OUTPUT"
      - uses: peter-evans/create-pull-request@v8.1.0
        with:
          assignees: ${{ github.actor }}
          commit-message: ${{ steps.pr-metadata.outputs.commit_message }}
          title: ${{ steps.pr-metadata.outputs.title }}
          body: ${{ steps.pr-metadata.outputs.body }}
          labels: "üìö documentation"
          branch: update-docs

  sync-workflows:
    name: ü™¢ Sync workflows
    if: github.repository != 'kdeldycke/repomatic'
    runs-on: ubuntu-slim
    steps:
      - uses: actions/checkout@v6.0.2
      - uses: astral-sh/setup-uv@v7.3.0
      - name: Re-create thin caller workflows
        run: uvx --no-progress --from . repomatic workflow sync --format thin-caller
      - name: Sync non-reusable workflow headers
        run: uvx --no-progress --from . repomatic workflow sync --format header-only
      - id: pr-metadata
        run: >
          uvx --no-progress --from . repomatic pr-body
          --template sync-workflows
          --output "$GITHUB_OUTPUT"
      - uses: peter-evans/create-pull-request@v8.1.0
        with:
          # We need custom PAT with workflows permissions to update .github/workflows/*.yaml files.
          token: ${{ secrets.WORKFLOW_UPDATE_GITHUB_PAT || secrets.GITHUB_TOKEN }}
          assignees: ${{ github.actor }}
          commit-message: ${{ steps.pr-metadata.outputs.commit_message }}
          title: ${{ steps.pr-metadata.outputs.title }}
          body: ${{ steps.pr-metadata.outputs.body }}
          labels: "ü§ñ ci"
          branch: sync-workflows
      - name: PAT setup hint
        if: failure() && !env.HAS_WORKFLOW_PAT
        run: >
          echo "::error::WORKFLOW_UPDATE_GITHUB_PAT is not configured.
          The default GITHUB_TOKEN cannot push changes to .github/workflows/ files.
          See ${{ github.server_url }}/${{ github.repository }}/issues?q=is:issue+WORKFLOW_UPDATE_GITHUB_PAT+in:title"

  sync-awesome-template:
    name: üåü Sync awesome template
    if: >
      startsWith(github.event.repository.name, 'awesome-')
      && github.event.repository.name != 'awesome-template'
    runs-on: ubuntu-slim
    # We need custom PAT through the whole job so we get workflow permissions to update all the boilerplate .github
    # files from awesome-template.
    steps:
      - name: Initial checkout
        uses: actions/checkout@v6.0.2
        with:
          token: ${{ secrets.WORKFLOW_UPDATE_GITHUB_PAT || secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      - uses: astral-sh/setup-uv@v7.3.0
      - id: pr-metadata
        # Template variables are substituted by the template-sync action.
        env:
          GHA_PR_BODY_PREFIX: |
            Files synced from [`kdeldycke/awesome-template@${TEMPLATE_GIT_HASH}`
            repository](${SOURCE_REPO}/tree/${TEMPLATE_GIT_HASH}).
        run: uvx --no-progress --from . repomatic pr-body --output "$GITHUB_OUTPUT"
      - name: Sync from template repo
        id: template_sync
        uses: AndreasAugustin/actions-template-sync@v2.5.2
        with:
          github_token: ${{ secrets.WORKFLOW_UPDATE_GITHUB_PAT || secrets.GITHUB_TOKEN }}
          source_repo_path: kdeldycke/awesome-template
          # Action will update PR only if there is file changes. is_force_push_pr also force the PR to be updated
          # only if metadata changes.
          is_force_push_pr: true
          is_allow_hooks: true
          is_pr_cleanup: true
          # Replace "/kdeldycke/awesome-template/" in URLs by "/kdeldycke/awesome-<repo_id>/".
          hooks: >
            precommit:
              commands:
                - find ./.github/ -type f -iregex ".*\.\(md\|yaml\)$" -print -exec sed -i
                  "s/\/kdeldycke\/awesome-template\//\/kdeldycke\/${{ github.event.repository.name }}\//g" "{}" \;
          pr_title: Sync from `awesome-template`
          pr_commit_msg: Sync from `awesome-template`
          pr_branch_name_prefix: "sync-awesome-template"
          pr_body: ${{ steps.pr-metadata.outputs.body }}
          pr_labels: "üìö documentation"
