---
name: Autofix
"on":
  workflow_call:
  workflow_dispatch:
  push:
    branches:
      - main

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: ${{ !startsWith(github.event.head_commit.message, '[changelog] Release') }}

jobs:

  setup-guide:
    name: Setup guide
    # Only run on push to the default branch, not on workflow_call from downstream.
    # Skip on the upstream repo itself (it already has the secret).
    if: github.event_name == 'push' && github.repository != 'kdeldycke/workflows'
    runs-on: ubuntu-slim
    permissions:
      issues: write
    steps:
      - uses: actions/checkout@v6.0.2
      - uses: astral-sh/setup-uv@v7.2.1
      - name: Manage setup guide issue
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: >
          uvx --no-progress --from . gha-utils setup-guide
          ${{ secrets.WORKFLOW_UPDATE_GITHUB_PAT && '--has-pat' || '' }}

  project-metadata:
    name: Project metadata
    runs-on: ubuntu-slim
    outputs:
      gitignore_exists: ${{ steps.project-metadata.outputs.gitignore_exists }}
      python_files: ${{ steps.project-metadata.outputs.python_files }}
      json_files: ${{ steps.project-metadata.outputs.json_files }}
      doc_files: ${{ steps.project-metadata.outputs.doc_files }}
      markdown_files: ${{ steps.project-metadata.outputs.markdown_files }}
      is_python_project: ${{ steps.project-metadata.outputs.is_python_project }}
      mailmap_exists: ${{ steps.project-metadata.outputs.mailmap_exists }}
      image_files: ${{ steps.project-metadata.outputs.image_files }}
      active_autodoc: ${{ steps.project-metadata.outputs.active_autodoc }}
      release_commits_matrix: ${{ steps.project-metadata.outputs.release_commits_matrix }}
    steps:
      - uses: actions/checkout@v6.0.2
      - uses: astral-sh/setup-uv@v7.2.1
      - name: Run gha-utils metadata
        id: project-metadata
        run: uvx --no-progress --from . gha-utils metadata --output "$GITHUB_OUTPUT"

  # --- Formatters: rewrite files to enforce canonical style. ---

  format-python:
    name: Format Python
    needs:
      - project-metadata
    # Ruff can format code in both Python and Markdown files.
    if: needs.project-metadata.outputs.python_files || needs.project-metadata.outputs.doc_files
    runs-on: ubuntu-slim
    steps:
      - uses: actions/checkout@v6.0.2
      - uses: astral-sh/setup-uv@v7.2.1
      - name: Run autopep8
        if: needs.project-metadata.outputs.python_files
        # Ruff is not wrapping comments: https://github.com/astral-sh/ruff/issues/7414
        # We use autopep8 to only wrap long-line comments:
        #  - E501 is "Try to make lines fit within --max-line-length characters."
        #  - --aggressive is requires to force autopep8 to consider comments.
        # Explicit list of files is provided, as autopep8 is not able to handle find files in ".github" subdirectory.
        run: >
          uvx --no-progress 'autopep8==2.3.2' --recursive --in-place --max-line-length 88 --select E501 --aggressive
          ${{ needs.project-metadata.outputs.python_files }}
      - name: Install Ruff and init config
        # Initialize [tool.ruff] in pyproject.toml if it doesn't exist.
        # Projects with existing ruff config will keep their settings.
        run: |
          uv tool install 'ruff==0.15.0'
          uvx --no-progress --from . gha-utils init ruff
      # XXX Ruff is planning to support linting and formatting in one unified command at one point.
      #     See: https://github.com/astral-sh/ruff/issues/8232
      - name: Run Ruff
        run: |
          ruff check --output-format github
          ruff format --output-format github
      - id: pr-metadata
        run: >
          uvx --no-progress --from . gha-utils pr-body
          --template format-python
          --output "$GITHUB_OUTPUT"
      - uses: peter-evans/create-pull-request@v8.1.0
        with:
          assignees: ${{ github.actor }}
          commit-message: ${{ steps.pr-metadata.outputs.commit_message }}
          title: ${{ steps.pr-metadata.outputs.title }}
          body: ${{ steps.pr-metadata.outputs.body }}
          labels: "ðŸ¤– ci"
          branch: format-python

  format-pyproject:
    name: Format pyproject.toml
    needs:
      - project-metadata
    if: fromJSON(needs.project-metadata.outputs.is_python_project)
    runs-on: ubuntu-slim
    steps:
      - uses: actions/checkout@v6.0.2
      - uses: astral-sh/setup-uv@v7.2.1
      - name: Run pyproject-fmt
        # pyproject-fmt returns exit code 1 when it reformats the file.
        # We ignore this since changes are expected in an autofix workflow.
        run: >
          uvx --no-progress 'pyproject-fmt==2.15.1'
          --expand-tables project.entry-points,project.optional-dependencies,project.urls,project.scripts
          pyproject.toml || true
      - id: pr-metadata
        run: >
          uvx --no-progress --from . gha-utils pr-body
          --template format-pyproject
          --output "$GITHUB_OUTPUT"
      - uses: peter-evans/create-pull-request@v8.1.0
        with:
          assignees: ${{ github.actor }}
          commit-message: ${{ steps.pr-metadata.outputs.commit_message }}
          title: ${{ steps.pr-metadata.outputs.title }}
          body: ${{ steps.pr-metadata.outputs.body }}
          labels: "ðŸ¤– ci"
          branch: format-pyproject

  format-markdown:
    name: Format Markdown
    needs:
      - project-metadata
    if: needs.project-metadata.outputs.markdown_files
    # Cannot use "ubuntu-slim" because shfmt is not available there.
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v6.0.2
      - uses: astral-sh/setup-uv@v7.2.1
      # https://mdformat.readthedocs.io/en/stable/users/plugins.html
      - name: Install mdformat
        # XXX mdformat-pelican is capped at mdformat<0.8.0 so it block the whole ecosystem from upgrading:
        # https://github.com/gaige/mdformat-pelican/pull/8
        run: >
          uv tool install
          --with 'mdformat_admon==2.1.1'
          --with 'mdformat-config==0.2.1'
          --with 'mdformat_deflist==0.1.4'
          --with 'mdformat_footnote==0.1.3'
          --with 'mdformat-front-matters==2.0.0'
          --with 'mdformat-gfm==1.0.0'
          --with 'mdformat_gfm_alerts==2.0.0'
          --with 'mdformat_myst==0.3.0'
          --with 'mdformat-pelican @ git+https://github.com/kdeldycke/mdformat-pelican@fix-mdformat-1.0.0'
          --with 'mdformat_pyproject==0.1.1'
          --with 'mdformat-recover-urls==0.0.2'
          --with 'mdformat-ruff==0.1.3'
          --with 'mdformat-shfmt==0.2.0'
          --with 'mdformat_simple_breaks==0.1.0'
          --with 'mdformat-toc==0.5.0'
          --with 'mdformat-web==0.2.0'
          --with 'ruff==0.15.0'
          'mdformat==1.0.0'
      - name: Install shfmt
        run: sudo apt install --yes shfmt
      - name: mdformat --version
        run: mdformat --version
      - name: Auto-format Markdown
        run: >
          for file in ${{ needs.project-metadata.outputs.markdown_files }}; do
          mdformat --number --strict-front-matter "$file";
          done
      - name: Markdown fixes for Awesome Lists
        if: startsWith(github.event.repository.name, 'awesome-')
        # Remove forbidden TOC entries: https://github.com/sindresorhus/awesome-lint/blob/v2.2.2/rules/toc.js#L14-L18
        # Also remove the title of the section containing the TOC (i.e. "Contents") to fix the following error:
        # âœ–  26:1  ToC item "Contents" does not match corresponding heading "Meta"  remark-lint:awesome-toc
        #
        # mdformat-toc has pending PRs to support this feature:
        # https://github.com/hukkin/mdformat-toc/issues/17
        # https://github.com/hukkin/mdformat-toc/pull/20
        run: >
          find ./ -type f \( -name 'readme.md' -or -name 'readme.*.md' \) -print
          -exec gawk -i inplace '!/^- \[(Contents|Contributing|Footnotes|Related Lists)\]\(#.+\)$/{print}' "{}" \;
      - id: pr-metadata
        run: >
          uvx --no-progress --from . gha-utils pr-body
          --template format-markdown
          --output "$GITHUB_OUTPUT"
      - uses: peter-evans/create-pull-request@v8.1.0
        with:
          assignees: ${{ github.actor }}
          commit-message: ${{ steps.pr-metadata.outputs.commit_message }}
          title: ${{ steps.pr-metadata.outputs.title }}
          body: ${{ steps.pr-metadata.outputs.body }}
          labels: "ðŸ“š documentation"
          branch: format-markdown

  format-json:
    name: Format JSON
    needs:
      - project-metadata
    if: needs.project-metadata.outputs.json_files
    runs-on: ubuntu-slim
    steps:
      - uses: actions/checkout@v6.0.2
      - uses: astral-sh/setup-uv@v7.2.1
      - name: Install Biome
        run: |
          curl -fsSL \
            "https://github.com/biomejs/biome/releases/download/%40biomejs%2Fbiome%402.3.12/biome-linux-x64" \
            --output /tmp/biome
          echo "a5251fa687b35f8fc06d17dc0794c5b117f1667056bc9f7f268a3268a9b56b78  /tmp/biome" | sha256sum --check
          install /tmp/biome /usr/local/bin/biome
      - name: Format JSON
        # Allow comments and trailing commas for JSONC files.
        # Biome auto-detects well-known JSONC files (tsconfig.json, etc.).
        run: >
          biome format --write
          --no-errors-on-unmatched
          --json-parse-allow-comments=true
          --json-parse-allow-trailing-commas=true
          ${{ needs.project-metadata.outputs.json_files }}
      - id: pr-metadata
        run: >
          uvx --no-progress --from . gha-utils pr-body
          --template format-json
          --output "$GITHUB_OUTPUT"
      - uses: peter-evans/create-pull-request@v8.1.0
        with:
          assignees: ${{ github.actor }}
          commit-message: ${{ steps.pr-metadata.outputs.commit_message }}
          title: ${{ steps.pr-metadata.outputs.title }}
          body: ${{ steps.pr-metadata.outputs.body }}
          labels: "ðŸ¤– ci"
          branch: format-json

  # --- Fixers: correct or improve existing content in-place. ---

  fix-typos:
    name: Fix typos
    runs-on: ubuntu-slim
    steps:
      - uses: actions/checkout@v6.0.2
      - uses: astral-sh/setup-uv@v7.2.1
      - name: Install typos
        run: |
          curl -fsSL \
            "https://github.com/crate-ci/typos/releases/download/v1.42.3/typos-v1.42.3-x86_64-unknown-linux-musl.tar.gz" \
            --output /tmp/typos.tar.gz
          echo "e083bf917d840563e77b35b64f43924d98fcb77acb69691455099d39e347d67d  /tmp/typos.tar.gz" | sha256sum --check
          tar xz --no-same-owner --directory=/usr/local/bin --file=/tmp/typos.tar.gz
      - name: Fix typos
        run: typos --write-changes
      - id: pr-metadata
        run: >
          uvx --no-progress --from . gha-utils pr-body
          --template fix-typos
          --output "$GITHUB_OUTPUT"
      - uses: peter-evans/create-pull-request@v8.1.0
        with:
          # We need custom PAT with workflows permissions to fix typos in .github/workflows/*.yaml` files.
          token: ${{ secrets.WORKFLOW_UPDATE_GITHUB_PAT || secrets.GITHUB_TOKEN }}
          assignees: ${{ github.actor }}
          commit-message: ${{ steps.pr-metadata.outputs.commit_message }}
          title: ${{ steps.pr-metadata.outputs.title }}
          body: ${{ steps.pr-metadata.outputs.body }}
          labels: "ðŸ“š documentation"
          branch: autofix-typo

  optimize-images:
    name: Optimize images
    needs:
      - project-metadata
    if: needs.project-metadata.outputs.image_files
    # Cannot use "ubuntu-slim" here because calibreapp/image-actions rely on Docker.
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v6.0.2
      - uses: astral-sh/setup-uv@v7.2.1
      - uses: calibreapp/image-actions@1.4.1
        id: image_actions
        with:
          compressOnly: true
      - id: pr-metadata
        env:
          GHA_PR_BODY_PREFIX: ${{ steps.image_actions.outputs.markdown }}
        run: uvx --no-progress --from . gha-utils pr-body --output "$GITHUB_OUTPUT"
      - uses: peter-evans/create-pull-request@v8.1.0
        with:
          assignees: ${{ github.actor }}
          commit-message: Optimize images
          title: Optimize images
          body: ${{ steps.pr-metadata.outputs.body }}
          labels: "ðŸ“š documentation"
          branch: optimize-images

  # --- Syncers: regenerate files from external sources or project state. ---

  update-gitignore:
    name: Update .gitignore
    needs:
      - project-metadata
    if: fromJSON(needs.project-metadata.outputs.gitignore_exists)
    runs-on: ubuntu-slim
    steps:
      - uses: actions/checkout@v6.0.2
      - uses: astral-sh/setup-uv@v7.2.1
      - name: Generate .gitignore
        run: uvx --no-progress --from . gha-utils update-gitignore
      - id: pr-metadata
        run: >
          uvx --no-progress --from . gha-utils pr-body
          --template update-gitignore
          --output "$GITHUB_OUTPUT"
      - uses: peter-evans/create-pull-request@v8.1.0
        with:
          assignees: ${{ github.actor }}
          commit-message: ${{ steps.pr-metadata.outputs.commit_message }}
          title: ${{ steps.pr-metadata.outputs.title }}
          body: ${{ steps.pr-metadata.outputs.body }}
          labels: "ðŸ¤– ci"
          branch: update-gitignore

  sync-bumpversion:
    name: Sync bumpversion config
    runs-on: ubuntu-slim
    steps:
      - uses: actions/checkout@v6.0.2
      - uses: astral-sh/setup-uv@v7.2.1
      - name: Initialize bumpversion config
        run: uvx --no-progress --from . gha-utils init bumpversion
      - id: pr-metadata
        run: >
          uvx --no-progress --from . gha-utils pr-body
          --template sync-bumpversion
          --output "$GITHUB_OUTPUT"
      - uses: peter-evans/create-pull-request@v8.1.0
        with:
          assignees: ${{ github.actor }}
          commit-message: ${{ steps.pr-metadata.outputs.commit_message }}
          title: ${{ steps.pr-metadata.outputs.title }}
          body: ${{ steps.pr-metadata.outputs.body }}
          labels: "ðŸ¤– ci"
          branch: sync-bumpversion

  update-mailmap:
    name: Update .mailmap
    needs:
      - project-metadata
    if: fromJSON(needs.project-metadata.outputs.mailmap_exists)
    runs-on: ubuntu-slim
    steps:
      - uses: actions/checkout@v6.0.2
        with:
          # Fetch all history to extract all contributors.
          fetch-depth: 0
      - uses: astral-sh/setup-uv@v7.2.1
      - name: Generate .mailmap
        run: uvx --no-progress --from . gha-utils mailmap-sync --skip-if-missing
      - id: pr-metadata
        run: >
          uvx --no-progress --from . gha-utils pr-body
          --template update-mailmap
          --output "$GITHUB_OUTPUT"
      - uses: peter-evans/create-pull-request@v8.1.0
        with:
          assignees: ${{ github.actor }}
          commit-message: ${{ steps.pr-metadata.outputs.commit_message }}
          title: ${{ steps.pr-metadata.outputs.title }}
          body: ${{ steps.pr-metadata.outputs.body }}
          labels: "ðŸ“š documentation"
          branch: update-mailmap

  update-deps-graph:
    name: Update dependency graph
    needs:
      - project-metadata
    # Only update dependency graph on release to avoid noise from transitive dependency changes.
    if: >
      fromJSON(needs.project-metadata.outputs.is_python_project)
      && needs.project-metadata.outputs.release_commits_matrix
    runs-on: ubuntu-slim
    steps:
      - uses: actions/checkout@v6.0.2
      - uses: astral-sh/setup-uv@v7.2.1
      - name: Generate graph
        # Package name and output path are auto-detected from pyproject.toml.
        run: uvx --no-progress --from . gha-utils deps-graph --all-groups --all-extras
      - id: pr-metadata
        run: >
          uvx --no-progress --from . gha-utils pr-body
          --template update-deps-graph
          --output "$GITHUB_OUTPUT"
      - uses: peter-evans/create-pull-request@v8.1.0
        with:
          assignees: ${{ github.actor }}
          commit-message: ${{ steps.pr-metadata.outputs.commit_message }}
          title: ${{ steps.pr-metadata.outputs.title }}
          body: ${{ steps.pr-metadata.outputs.body }}
          labels: "ðŸ“š documentation"
          branch: update-deps-graph

  update-docs:
    name: Update docs
    needs:
      - project-metadata
    if: >
      fromJSON(needs.project-metadata.outputs.is_python_project)
      && fromJSON(needs.project-metadata.outputs.active_autodoc)
    runs-on: ubuntu-slim
    steps:
      - uses: actions/checkout@v6.0.2
      - uses: astral-sh/setup-uv@v7.2.1
      - name: Regenerate Sphinx autodoc
        # Omit --force so existing RST files (often with custom modifications produced by the next step) are preserved.
        # Only new module stubs are created, and deleted ones are left for manual removal by the maintainers.
        run: uv --no-progress run --frozen --group docs -- sphinx-apidoc --no-toc --module-first --output-dir ./docs .
      - name: Run docs update script
        # Run docs/docs_update.py if present to generate dynamic content (tables, diagrams, directives).
        run: |
          if [ -f docs/docs_update.py ]; then
            uv --no-progress run --frozen --group docs -- python docs/docs_update.py
          fi
      - id: pr-metadata
        run: >
          uvx --no-progress --from . gha-utils pr-body
          --template update-docs
          --output "$GITHUB_OUTPUT"
      - uses: peter-evans/create-pull-request@v8.1.0
        with:
          assignees: ${{ github.actor }}
          commit-message: ${{ steps.pr-metadata.outputs.commit_message }}
          title: ${{ steps.pr-metadata.outputs.title }}
          body: ${{ steps.pr-metadata.outputs.body }}
          labels: "ðŸ“š documentation"
          branch: update-docs

  sync-workflows:
    name: Sync workflows
    if: github.repository != 'kdeldycke/workflows'
    runs-on: ubuntu-slim
    steps:
      - uses: actions/checkout@v6.0.2
      - uses: astral-sh/setup-uv@v7.2.1
      - name: Sync workflow files
        run: uvx --no-progress --from . gha-utils workflow sync
      - id: pr-metadata
        run: >
          uvx --no-progress --from . gha-utils pr-body
          --template sync-workflows
          --output "$GITHUB_OUTPUT"
      - uses: peter-evans/create-pull-request@v8.1.0
        with:
          # We need custom PAT with workflows permissions to update .github/workflows/*.yaml files.
          token: ${{ secrets.WORKFLOW_UPDATE_GITHUB_PAT || secrets.GITHUB_TOKEN }}
          assignees: ${{ github.actor }}
          commit-message: ${{ steps.pr-metadata.outputs.commit_message }}
          title: ${{ steps.pr-metadata.outputs.title }}
          body: ${{ steps.pr-metadata.outputs.body }}
          labels: "ðŸ¤– ci"
          branch: sync-workflows

  sync-awesome-template:
    name: Sync awesome template
    if: >
      startsWith(github.event.repository.name, 'awesome-')
      && github.event.repository.name != 'awesome-template'
    runs-on: ubuntu-slim
    # We need custom PAT through the whole job so we get workflow permissions to update all the boilerplate .github
    # files from awesome-template.
    steps:
      - name: Initial checkout
        uses: actions/checkout@v6.0.2
        with:
          token: ${{ secrets.WORKFLOW_UPDATE_GITHUB_PAT || secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      - uses: astral-sh/setup-uv@v7.2.1
      - id: pr-metadata
        # Template variables are substituted by the template-sync action.
        env:
          GHA_PR_BODY_PREFIX: |
            Files synced from [`kdeldycke/awesome-template@${TEMPLATE_GIT_HASH}`
            repository](${SOURCE_REPO}/tree/${TEMPLATE_GIT_HASH}).
        run: uvx --no-progress --from . gha-utils pr-body --output "$GITHUB_OUTPUT"
      - name: Sync from template repo
        id: template_sync
        uses: AndreasAugustin/actions-template-sync@v2.5.2
        with:
          github_token: ${{ secrets.WORKFLOW_UPDATE_GITHUB_PAT || secrets.GITHUB_TOKEN }}
          source_repo_path: kdeldycke/awesome-template
          # Action will update PR only if there is file changes. is_force_push_pr also force the PR to be updated
          # only if metadata changes.
          is_force_push_pr: true
          is_allow_hooks: true
          is_pr_cleanup: true
          # Replace "/kdeldycke/awesome-template/" in URLs by "/kdeldycke/awesome-<repo_id>/".
          hooks: >
            precommit:
              commands:
                - find ./.github/ -type f -iregex ".*\.\(md\|yaml\)$" -print -exec sed -i
                  "s/\/kdeldycke\/awesome-template\//\/kdeldycke\/${{ github.event.repository.name }}\//g" "{}" \;
          pr_title: Sync from `awesome-template`
          pr_commit_msg: Sync from `awesome-template`
          pr_branch_name_prefix: "sync-awesome-template"
          pr_body: ${{ steps.pr-metadata.outputs.body }}
          pr_labels: "ðŸ“š documentation"