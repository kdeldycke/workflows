---
name: Autofix
"on":
  workflow_call:
    inputs:
      gitignore-location:
        description: 'File path of the .gitignore to update, relative to the root of the repository.'
        default: './.gitignore'
        required: false
        type: string
      gitignore-extra-categories:
        description: 'List of additional categories to add to gitignore file.'
        required: false
        type: string
  push:
    branches:
      - main

concurrency:
  # Group workflow jobs so new commits cancels in-progress execution triggered by previous commits.
  # Source: https://mail.python.org/archives/list/pypa-committers@python.org/thread/PCBCQMJF64JGRBOX7E2EE4YLKHT4DI55/
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.sha }}
  cancel-in-progress: true

jobs:

  project-metadata:
    name: Project metadata
    runs-on: ubuntu-22.04
    outputs:
      python_files: ${{ steps.project-metadata.outputs.python_files }}
      doc_files: ${{ needs.project-metadata.outputs.doc_files }}
      black_params: ${{ steps.project-metadata.outputs.black_params }}
      pyupgrade_params: ${{ steps.project-metadata.outputs.pyupgrade_params }}
    steps:
      - uses: actions/checkout@v3.3.0
        with:
          # Checkout pull request HEAD commit to ignore actions/checkout's merge commit. Fallback to push SHA.
          ref: ${{ github.event.pull_request.head.sha || github.sha }}
          # We're going to browse all new commits.
          fetch-depth: 0
      - uses: actions/setup-python@v4.5.0
        with:
          python-version: "3.11"
      - name: Install pip
        run: |
          python -m pip install --upgrade pip
      - name: Install Poetry
        run: >
          python -m pip install --requirement
          https://raw.githubusercontent.com/kdeldycke/workflows/main/requirements.txt
      - name: Project metadata
        id: project-metadata
        env:
          GITHUB_CONTEXT: ${{ toJSON(github) }}
        run: >
          python -c "$(curl -fsSL
          https://raw.githubusercontent.com/kdeldycke/workflows/main/.github/metadata.py)"

  modernize-python:
    name: Modernize Python
    needs:
      - project-metadata
    if: needs.project-metadata.outputs.python_files && needs.project-metadata.outputs.pyupgrade_params
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v3.3.0
      - uses: actions/setup-python@v4.5.0
        with:
          python-version: "3.11"
      - name: Install pip
        run: |
          python -m pip install --upgrade pip
      - name: Install pyupgrade
        run: >
          python -m pip install --requirement
          https://raw.githubusercontent.com/kdeldycke/workflows/main/requirements.txt
      - name: Run pyupgrade
        run: >
          pyupgrade
          --exit-zero-even-if-changed
          ${{ needs.project-metadata.outputs.pyupgrade_params }}
          ${{ needs.project-metadata.outputs.python_files }}
      - uses: peter-evans/create-pull-request@v4.2.3
        with:
          assignees: ${{ github.actor }}
          commit-message: "[autofix] Modernize Python"
          title: "[autofix] Modernize Python"
          body: >
            <details><summary><code>Workflow metadata</code></summary>


            > [Auto-generated on run `#${{ github.run_id }}`](${{ github.event.repository.html_url }}/actions/runs/${{
            github.run_id }}) by `${{ github.job }}` job from [`autofix.yaml`](${{ github.event.repository.html_url
            }}/blob/${{ github.sha }}/.github/workflows/autofix.yaml) workflow.


            </details>
          labels: "ðŸ¤– ci"
          branch: modernize-python

  format-python:
    name: Format Python
    needs:
      - project-metadata
    if: needs.project-metadata.outputs.python_files || needs.project-metadata.outputs.doc_files
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v3.3.0
      - uses: actions/setup-python@v4.5.0
        with:
          python-version: "3.11"
      - name: Install pip
        run: |
          python -m pip install --upgrade pip
      - name: Install pycln, isort, black, blacken-docs, autopep8 and docformatter
        run: >
          python -m pip install --requirement
          https://raw.githubusercontent.com/kdeldycke/workflows/main/requirements.txt
      - name: Run pycln
        # Black is not removing unused imports, as per https://github.com/psf/black/issues/86 . So we rely on pycln.
        run: |
          pycln --all .
      - name: Run isort
        # https://black.readthedocs.io/en/stable/guides/using_black_with_other_tools.html#isort
        run: |
          isort --profile black .
      - name: Run Black
        run: |
          black ${{ needs.project-metadata.outputs.black_params }} .
      - name: Run blacken-docs
        # blacken-docs reuses Black's ``--target-version pyXY`` parameter.
        # Ignore failing command: blacken-docs returns 1 if it finds a file that needs to be reformatted:
        # https://github.com/adamchainz/blacken-docs/blob/79ef671/blacken_docs.py#L207-L211
        run: >
          blacken-docs
          --line-length 88
          ${{ needs.project-metadata.outputs.black_params }}
          ${{ needs.project-metadata.outputs.python_files }}
          ${{ needs.project-metadata.outputs.doc_files }}
          || true
      - name: Run autopep8
        # Black is not formatting comments, as per https://github.com/psf/black/issues/181#issuecomment-385326100 .
        # We use autopep8 to only wrap long-line comments and reduce Pylint complaints.
        #  - E501 is "Try to make lines fit within --max-line-length characters."
        #  - --aggressive is requires to force autopep8 to consider comments.
        run: |
          autopep8 --recursive --in-place --max-line-length 88 --select E501 --aggressive .
      - name: Run docformatter
        # Always ignore failing command, as docformatter returns exit code 3 if it finds a file that needs to be
        # reformatted:
        # https://github.com/PyCQA/docformatter/issues/157#issuecomment-1402573058
        # https://github.com/PyCQA/docformatter/commit/f7d50ae
        run: |
          docformatter --recursive --in-place --wrap-summaries 88 --wrap-descriptions 88 . || true
      - uses: peter-evans/create-pull-request@v4.2.3
        with:
          assignees: ${{ github.actor }}
          commit-message: "[autofix] Format Python"
          title: "[autofix] Format Python"
          body: >
            <details><summary><code>Workflow metadata</code></summary>


            > [Auto-generated on run `#${{ github.run_id }}`](${{ github.event.repository.html_url }}/actions/runs/${{
            github.run_id }}) by `${{ github.job }}` job from [`autofix.yaml`](${{ github.event.repository.html_url
            }}/blob/${{ github.sha }}/.github/workflows/autofix.yaml) workflow.


            </details>
          labels: "ðŸ¤– ci"
          branch: format-python

  format-markdown:
    name: Format Markdown
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v3.3.0
      - name: Install pip
        run: |
          python -m pip install --upgrade pip
      - name: Install mdformat
        run: >
          python -m pip install --requirement
          https://raw.githubusercontent.com/kdeldycke/workflows/main/requirements.txt
      - name: Auto-format Markdown
        run: |
          find ./ -iname "*.md" -exec mdformat "{}" \;
      - name: Remove forbidden TOC entries in awesome lists
        if: startsWith(github.event.repository.name, 'awesome-')
        # See: https://github.com/sindresorhus/awesome-lint/blob/v0.18.0/rules/toc.js#L15-L18
        # Also remove the title of the section containing the TOC (i.e. "Contents") to fix the following error:
        #   âœ–  26:1  ToC item "Contents" does not match corresponding heading "Meta"  remark-lint:awesome-toc
        # TODO: contribute these fixes to mdformat-toc as configurable options.
        run: |
          gawk -i inplace '!/^- \[(Contents|Contributing|Footnotes)\]\(#.+\)$/{print}' ./readme.md
      - uses: peter-evans/create-pull-request@v4.2.3
        with:
          assignees: ${{ github.actor }}
          commit-message: "[autofix] Format Markdown"
          title: "[autofix] Format Markdown"
          body: >
            <details><summary><code>Workflow metadata</code></summary>


            > [Auto-generated on run `#${{ github.run_id }}`](${{ github.event.repository.html_url }}/actions/runs/${{
            github.run_id }}) by `${{ github.job }}` job from [`autofix.yaml`](${{ github.event.repository.html_url
            }}/blob/${{ github.sha }}/.github/workflows/autofix.yaml) workflow.


            </details>
          labels: "ðŸ“š documentation"
          branch: format-markdown

  format-json:
    name: Format JSON
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v3.3.0
      - name: Install jsonlint
        run: |
          sudo npm install --global jsonlint
      - name: Lint
        run: |
          find ./ -type f -name '*.json' -print -exec jsonlint --in-place "{}" \;
      - uses: peter-evans/create-pull-request@v4.2.3
        with:
          assignees: ${{ github.actor }}
          commit-message: "[autofix] Format JSON"
          title: "[autofix] Format JSON"
          body: >
            <details><summary><code>Workflow metadata</code></summary>


            > [Auto-generated on run `#${{ github.run_id }}`](${{ github.event.repository.html_url }}/actions/runs/${{
            github.run_id }}) by `${{ github.job }}` job from [`autofix.yaml`](${{ github.event.repository.html_url
            }}/blob/${{ github.sha }}/.github/workflows/autofix.yaml) workflow.


            </details>
          labels: "ðŸ¤– ci"
          branch: format-json

  check-gitignore:
    name: Does .gitignore exist?
    runs-on: ubuntu-22.04
    outputs:
      exists: ${{ steps.detection.outputs.exists }}
    steps:
      - uses: actions/checkout@v3.3.0
      - id: detection
        # Bare-called reused workflow are not fed with defaults, so force it here.
        run: |
          echo "exists=$( [[ -f '${{ inputs.gitignore-location }}' ]] && echo 'true' )" >> $GITHUB_OUTPUT
      - name: Detection results
        run: |
          echo "Does .gitignore exist at root? ${{ steps.detection.outputs.exists && true || false }}"

  update-gitignore:
    name: Update .gitignore
    needs:
      - check-gitignore
    # Only update gitignore if a file is found at the root of repository.
    if: needs.check-gitignore.outputs.exists
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v3.3.0
      - name: Install git-extras
        run: |
          sudo apt update
          sudo apt install --yes git-extras
      - name: Fetch category definitions
        # Update the list manually so the first call below will not introduce these extra log messages:
        #   -----Initial gitignore.io list----
        #   -----Save to /home/runner/.gi_list-----
        run: |
          git ignore-io --update-list
      - name: Generate .gitignore
        run: >
          git ignore-io emacs git linux macos nohup python vim virtualenv visualstudiocode windows
          ${{ inputs.gitignore-extra-categories }} > ${{ inputs.gitignore-location }}
      - uses: peter-evans/create-pull-request@v4.2.3
        with:
          assignees: ${{ github.actor }}
          commit-message: "[autofix] Update .gitignore"
          title: "[autofix] Update .gitignore"
          body: >
            <details><summary><code>Workflow metadata</code></summary>


            > [Auto-generated on run `#${{ github.run_id }}`](${{ github.event.repository.html_url }}/actions/runs/${{
            github.run_id }}) by `${{ github.job }}` job from [`autofix.yaml`](${{ github.event.repository.html_url
            }}/blob/${{ github.sha }}/.github/workflows/autofix.yaml) workflow.


            </details>
          labels: "ðŸ¤– ci"
          branch: update-gitignore
