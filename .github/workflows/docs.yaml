---
name: Docs
"on":
  workflow_call:
    inputs:
      dependency-graph-output:
        description: 'Location in the repository of the dependency graph image.'
        required: false
        type: string
        default: ./docs/assets/dependencies.mmd
  workflow_dispatch:
  push:
    branches:
      - main

# Defaults sets in workflow_call.inputs or workflow_dispatch.inputs are not propagated to other events.
# We have to manually manage them: https://github.com/orgs/community/discussions/39357#discussioncomment-7500641
env:
  dependency-graph-output: >-
    ${{ inputs.dependency-graph-output == null && './docs/assets/dependencies.mmd' || inputs.dependency-graph-output }}

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: ${{ !startsWith(github.event.head_commit.message, '[changelog] Release') }}

jobs:

  autofix-typo:
    name: Fix typos
    runs-on: ubuntu-slim
    steps:
      - uses: actions/checkout@v6.0.2
      - uses: crate-ci/typos@v1.42.1
        with:
          write_changes: true
      - name: Remove local typos binary
        run: rm ./typos
      - id: pr-metadata
        uses: kdeldycke/workflows/.github/actions/pr-metadata@main
      - uses: peter-evans/create-pull-request@v8.1.0
        with:
          # We need custom PAT with workflows permissions to fix typos in .github/workflows/*.yaml` files.
          token: ${{ secrets.WORKFLOW_UPDATE_GITHUB_PAT || secrets.GITHUB_TOKEN }}
          assignees: ${{ github.actor }}
          commit-message: "[autofix] Typo"
          title: "[autofix] Typo"
          body: ${{ steps.pr-metadata.outputs.body }}
          labels: "ðŸ“š documentation"
          branch: autofix-typo

  project-metadata:
    name: Project metadata
    runs-on: ubuntu-slim
    outputs:
      mailmap_exists: ${{ steps.project-metadata.outputs.mailmap_exists }}
      image_files: ${{ steps.project-metadata.outputs.image_files }}
      is_python_project: ${{ steps.project-metadata.outputs.is_python_project }}
      package_name: ${{ steps.project-metadata.outputs.package_name }}
      is_sphinx: ${{ steps.project-metadata.outputs.is_sphinx }}
      active_autodoc: ${{ steps.project-metadata.outputs.active_autodoc }}
      release_commits_matrix: ${{ steps.project-metadata.outputs.release_commits_matrix }}
    steps:
      - uses: actions/checkout@v6.0.2
      - uses: astral-sh/setup-uv@v7.2.0
      - name: Run gha-utils metadata
        id: project-metadata
        run: |
          uvx --no-progress 'gha-utils==5.6.1' metadata --output "$GITHUB_OUTPUT"

  optimize-images:
    name: Optimize images
    needs:
      - project-metadata
    if: needs.project-metadata.outputs.image_files
    # Cannot use "ubuntu-slim" here because calibreapp/image-actions rely on Docker.
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v6.0.2
      - uses: calibreapp/image-actions@1.4.1
        id: image_actions
        with:
          compressOnly: true
      - id: pr-metadata
        uses: kdeldycke/workflows/.github/actions/pr-metadata@main
        with:
          prefix: ${{ steps.image_actions.outputs.markdown }}
      - uses: peter-evans/create-pull-request@v8.1.0
        with:
          assignees: ${{ github.actor }}
          commit-message: "[autofix] Optimize images"
          title: "[autofix] Optimize images"
          body: ${{ steps.pr-metadata.outputs.body }}
          labels: "ðŸ“š documentation"
          branch: optimize-images

  update-mailmap:
    name: Update .mailmap
    needs:
      - project-metadata
    if: fromJSON(needs.project-metadata.outputs.mailmap_exists)
    runs-on: ubuntu-slim
    steps:
      - uses: actions/checkout@v6.0.2
        with:
          # Fetch all history to extract all contributors.
          fetch-depth: 0
      - uses: astral-sh/setup-uv@v7.2.0
      - name: Generate .mailmap
        run: |
          uvx --no-progress 'gha-utils==5.6.1' mailmap-sync --skip-if-missing ./.mailmap
      - id: pr-metadata
        uses: kdeldycke/workflows/.github/actions/pr-metadata@main
      - uses: peter-evans/create-pull-request@v8.1.0
        with:
          assignees: ${{ github.actor }}
          commit-message: "[autofix] Update .mailmap"
          title: "[autofix] Update `.mailmap`"
          body: ${{ steps.pr-metadata.outputs.body }}
          labels: "ðŸ“š documentation"
          branch: update-mailmap

  update-deps-graph:
    name: Update dependency graph
    needs:
      - project-metadata
    # Only update dependency graph on release to avoid noise from transitive dependency changes.
    if: >
      fromJSON(needs.project-metadata.outputs.is_python_project)
      && needs.project-metadata.outputs.release_commits_matrix
    runs-on: ubuntu-slim
    steps:
      - uses: actions/checkout@v6.0.2
      - uses: astral-sh/setup-uv@v7.2.0
      - name: Create dir structure
        run: |
          mkdir -p "$(dirname "${{ env.dependency-graph-output }}")"
      - name: Generate graph
        # Include all dependency groups in the graph with subgraphs.
        run: >
          uvx --no-progress 'gha-utils==5.6.1' deps-graph
          ${{ needs.project-metadata.outputs.package_name
          && format('--package {0}', needs.project-metadata.outputs.package_name)}}
          --all-groups --all-extras
          --output "${{ env.dependency-graph-output }}"
      - id: pr-metadata
        uses: kdeldycke/workflows/.github/actions/pr-metadata@main
      - uses: peter-evans/create-pull-request@v8.1.0
        with:
          assignees: ${{ github.actor }}
          commit-message: "[autofix] Regenerate dependency graph"
          title: "[autofix] Regenerate dependency graph"
          body: ${{ steps.pr-metadata.outputs.body }}
          labels: "ðŸ“š documentation"
          branch: update-deps-graph

  update-docs:
    name: Update docs
    needs:
      - project-metadata
    if: >
      fromJSON(needs.project-metadata.outputs.is_python_project)
      && fromJSON(needs.project-metadata.outputs.active_autodoc)
    runs-on: ubuntu-slim
    steps:
      - uses: actions/checkout@v6.0.2
      - uses: astral-sh/setup-uv@v7.2.0
      - name: Regenerate Sphinx autodoc
        run: |
          uv --no-progress run --frozen --group docs -- \
            sphinx-apidoc --no-toc --module-first --force --output-dir ./docs .
      - name: Run docs update script
        # Run docs/docs_update.py if present to generate dynamic content (tables, diagrams, directives).
        run: |
          if [ -f docs/docs_update.py ]; then
            uv --no-progress run --frozen --group docs -- python docs/docs_update.py
          fi
      - id: pr-metadata
        uses: kdeldycke/workflows/.github/actions/pr-metadata@main
      - uses: peter-evans/create-pull-request@v8.1.0
        with:
          assignees: ${{ github.actor }}
          commit-message: "[autofix] Update docs"
          title: "[autofix] Update docs"
          body: ${{ steps.pr-metadata.outputs.body }}
          labels: "ðŸ“š documentation"
          branch: update-docs

  deploy-docs:
    name: Deploy Sphinx doc
    needs:
      - project-metadata
    if: fromJSON(needs.project-metadata.outputs.is_python_project) && fromJSON(needs.project-metadata.outputs.is_sphinx)
    runs-on: ubuntu-slim
    steps:
      - uses: actions/checkout@v6.0.2
      - uses: astral-sh/setup-uv@v7.2.0
      - name: Install Graphviz
        # So we can use the sphinx.ext.graphviz plugin.
        # See: https://www.sphinx-doc.org/en/master/usage/extensions/graphviz.html
        run: |
          sudo apt update
          sudo apt install --yes graphviz
      - name: Build documentation
        # Install --all-extras so documentation can covers all features of the project, including the optional ones.
        run: |
          uv --no-progress run --frozen --all-extras --group docs -- sphinx-build -b html ./docs ./docs/html
      - name: Deploy
        uses: peaceiris/actions-gh-pages@v4.0.0
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./docs/html
          force_orphan: true

  sphinx-linkcheck:
    name: Sphinx linkcheck
    needs:
      - project-metadata
    # Skip all PRs as we won't have permissions to create issues.
    # Skip the prepare-release branch as it contains URLs pointing to tags that don't exist yet.
    # Skip any push containing a post-release bump commit as a precautionary measure.
    if: >
      github.event_name != 'pull_request'
      && github.ref != 'refs/heads/prepare-release'
      && (! contains(github.event.commits.*.message, '[changelog] Post-release version bump'))
      && fromJSON(needs.project-metadata.outputs.is_python_project)
      && fromJSON(needs.project-metadata.outputs.is_sphinx)
    runs-on: ubuntu-slim
    steps:
      - uses: actions/checkout@v6.0.2
      - uses: astral-sh/setup-uv@v7.2.0
      - name: Install Graphviz
        # So we can use the sphinx.ext.graphviz plugin.
        # See: https://www.sphinx-doc.org/en/master/usage/extensions/graphviz.html
        run: |
          sudo apt update
          sudo apt install --yes graphviz
      - name: Run Sphinx linkcheck
        # Do not use -W: we parse output.json directly instead of relying on exit codes.
        run: >
          uv --no-progress run --frozen --all-extras --group docs --
          sphinx-build -b linkcheck ./docs ./docs/linkcheck
        continue-on-error: true
      - name: Manage Sphinx linkcheck issue
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: >
          uvx --no-progress 'gha-utils==5.6.1' sphinx-linkcheck
          --output-json ./docs/linkcheck/output.json
          --repo-name "${{ github.event.repository.name }}"

  awesome-template-sync:
    name: Sync awesome template
    if: >
      startsWith(github.event.repository.name, 'awesome-')
      && github.event.repository.name != 'awesome-template'
    runs-on: ubuntu-slim
    # We need custom PAT through the whole job so we get workflow permissions to update all the boilerplate .github
    # files from awesome-template.
    steps:
      - name: Initial checkout
        uses: actions/checkout@v6.0.2
        with:
          token: ${{ secrets.WORKFLOW_UPDATE_GITHUB_PAT || secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      - id: pr-metadata
        uses: kdeldycke/workflows/.github/actions/pr-metadata@main
        with:
          # Template variables are substituted by the template-sync action.
          prefix: |
            Files synced from [`kdeldycke/awesome-template@${TEMPLATE_GIT_HASH}`
            repository](${SOURCE_REPO}/tree/${TEMPLATE_GIT_HASH}).
      - name: Sync from template repo
        id: template_sync
        uses: AndreasAugustin/actions-template-sync@v2.5.2
        with:
          github_token: ${{ secrets.WORKFLOW_UPDATE_GITHUB_PAT || secrets.GITHUB_TOKEN }}
          source_repo_path: kdeldycke/awesome-template
          # Action will update PR only if there is file changes. is_force_push_pr also force the PR to be updated
          # only if metadata changes.
          is_force_push_pr: true
          is_allow_hooks: true
          is_pr_cleanup: true
          # Replace "/kdeldycke/awesome-template/" in URLs by "/kdeldycke/awesome-<repo_id>/".
          hooks: >
            precommit:
              commands:
                - find ./.github/ -type f -iregex ".*\.\(md\|yaml\)$" -print -exec sed -i
                  "s/\/kdeldycke\/awesome-template\//\/kdeldycke\/${{ github.event.repository.name }}\//g" "{}" \;
          pr_title: "[sync] Updates from `awesome-template`"
          pr_commit_msg: "[sync] Updates from awesome-template"
          pr_branch_name_prefix: "sync-awesome-template"
          pr_body: ${{ steps.pr-metadata.outputs.body }}
          pr_labels: "ðŸ“š documentation"