---
name: Docs
"on":
  workflow_call:
  workflow_dispatch:
  push:
    branches:
      - main

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: ${{ !startsWith(github.event.head_commit.message, '[changelog] Release') }}

jobs:

  project-metadata:
    name: Project metadata
    runs-on: ubuntu-slim
    outputs:
      is_python_project: ${{ steps.project-metadata.outputs.is_python_project }}
      is_sphinx: ${{ steps.project-metadata.outputs.is_sphinx }}
      doc_files: ${{ steps.project-metadata.outputs.doc_files }}
    steps:
      - uses: actions/checkout@v6.0.2
      - uses: astral-sh/setup-uv@v7.2.1
      - name: Run gha-utils metadata
        id: project-metadata
        run: uvx --no-progress --from . gha-utils metadata --output "$GITHUB_OUTPUT"

  deploy-docs:
    name: Deploy Sphinx doc
    needs:
      - project-metadata
    if: fromJSON(needs.project-metadata.outputs.is_python_project) && fromJSON(needs.project-metadata.outputs.is_sphinx)
    runs-on: ubuntu-slim
    steps:
      - uses: actions/checkout@v6.0.2
      - uses: astral-sh/setup-uv@v7.2.1
      - name: Install Graphviz
        # So we can use the sphinx.ext.graphviz plugin.
        # See: https://www.sphinx-doc.org/en/master/usage/extensions/graphviz.html
        run: |
          sudo apt update
          sudo apt install --yes graphviz
      - name: Build documentation
        # Install --all-extras so documentation can covers all features of the project, including the optional ones.
        run: uv --no-progress run --frozen --all-extras --group docs -- sphinx-build -b html ./docs ./docs/html
      - name: Deploy
        uses: peaceiris/actions-gh-pages@v4.0.0
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./docs/html
          force_orphan: true

  check-broken-links:
    needs:
      - project-metadata
    # Skip all PRs as we won't have permissions to create issues.
    # Skip the prepare-release branch as it contains URLs pointing to tags that don't exist yet.
    # Skip any push containing a post-release bump commit as a precautionary measure.
    if: >
      github.event_name != 'pull_request'
      && github.ref != 'refs/heads/prepare-release'
      && (! contains(toJSON(github.event.commits.*.message), '[changelog] Post-release bump'))
      && (needs.project-metadata.outputs.doc_files
        || (fromJSON(needs.project-metadata.outputs.is_python_project)
          && fromJSON(needs.project-metadata.outputs.is_sphinx)))
    runs-on: ubuntu-slim
    steps:
      - uses: actions/checkout@v6.0.2
      - uses: astral-sh/setup-uv@v7.2.1
      - name: Install Graphviz
        if: >
          fromJSON(needs.project-metadata.outputs.is_python_project)
          && fromJSON(needs.project-metadata.outputs.is_sphinx)
        # So we can use the sphinx.ext.graphviz plugin.
        # See: https://www.sphinx-doc.org/en/master/usage/extensions/graphviz.html
        run: |
          sudo apt update
          sudo apt install --yes graphviz
      - name: Run Sphinx linkcheck
        if: >
          fromJSON(needs.project-metadata.outputs.is_python_project)
          && fromJSON(needs.project-metadata.outputs.is_sphinx)
        # Do not use -W: we parse output.json directly instead of relying on exit codes.
        run: >
          uv --no-progress run --frozen --all-extras --group docs --
          sphinx-build -b linkcheck ./docs ./docs/linkcheck
        continue-on-error: true
      - uses: lycheeverse/lychee-action@v2.7.0
        if: needs.project-metadata.outputs.doc_files
        id: lychee_run
        with:
          lycheeVersion: v0.23.0
          fail: false
          args: >
            --hidden
            --suggest
            --no-progress
            --include-fragments
            --exclude-all-private
            ${{ needs.project-metadata.outputs.doc_files }}
      - name: Manage broken links issue
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: >
          uvx --no-progress --from . gha-utils broken-links
          ${{ steps.lychee_run.outputs.exit_code != '' && format(
            '--lychee-exit-code {0}',
            steps.lychee_run.outputs.exit_code) || '' }}
