---
name: Changelog & versions
"on":
  workflow_call:
  push:
    branches:
      - main
    paths:
      - changelog.md
      - .bumpversion.cfg
      - .github/update_changelog.py
      - .github/workflows/changelog.yaml
      - .github/workflows/release.yaml
  schedule:
    # Run daily so the changelog date in prepare-release job is kept up to date
    - cron: "23 0 * * *"

jobs:

  version-increments:
    # This job is not time-sensitive: do not let it to be triggered by schedule event.
    # Also skip release commits (during which bumpversion cannot find "unreleased" string in changelog.md).
    if: github.event_name != 'schedule' && !startsWith(github.event.head_commit.message, '[changelog] Release v')
    runs-on: ubuntu-20.04
    strategy:
      matrix:
        part:
          - minor
          - major
    steps:
      - uses: actions/checkout@v2.4.0
      - uses: actions/setup-python@v2.2.2
      - name: Install pip
        run: |
          python -m pip install --upgrade pip
      - name: Install bumpversion
        run: >
          python -m pip install --requirement
          https://raw.githubusercontent.com/kdeldycke/workflows/v0.6.3/requirements.txt
      - name: ${{ matrix.part }} version bump
        run: |
          bumpversion --verbose ${{ matrix.part }}
      - name: Extract version
        id: get_version
        # Docs: https://docs.github.com/en/actions/learn-github-actions
        # /workflow-commands-for-github-actions#setting-an-output-parameter
        run: |
          echo "::set-output name=new_version::$( grep "current_version = " ./.bumpversion.cfg | cut -d ' ' -f 3 )"
      - name: Print version
        run: |
          echo "New version: ${{ steps.get_version.outputs.new_version }}"
      - uses: peter-evans/create-pull-request@v3.12.0
        with:
          assignees: ${{ github.actor }}
          commit-message: >
            [changelog] Bump ${{ matrix.part }} version to v${{ steps.get_version.outputs.new_version }}.
          title: >
            Bump ${{ matrix.part }} version to v${{ steps.get_version.outputs.new_version }}
          body: >
            Ready to be merged into `main` branch, at the discretion of the maintainers, to bump the ${{ matrix.part }}
            part of the version number.


            <details><summary><code>Workflow metadata</code></summary>


            > [Auto-generated on run `#${{ github.run_id }}`](${{ github.event.repository.html_url }}/actions/runs/${{
            github.run_id }}) by `${{ github.job }}` job from [`changelog.yaml`](${{ github.event.repository.html_url
            }}/blob/${{ github.sha }}/.github/workflows/changelog.yaml) workflow.


            </details>
          labels: "ðŸ†™ changelog"
          base: main
          branch: ${{ matrix.part }}-version-increment
          delete-branch: true
          draft: true

  prepare-release:
    runs-on: ubuntu-20.04
    steps:
      - uses: actions/checkout@v2.4.0
      - uses: actions/setup-python@v2.2.2
      - name: Install pip
        run: |
          python -m pip install --upgrade pip
      - name: Install bumpversion
        run: >
          python -m pip install --requirement
          https://raw.githubusercontent.com/kdeldycke/workflows/v0.6.3/requirements.txt
      - name: Extract version
        id: get_version
        # Docs: https://docs.github.com/en/actions/learn-github-actions
        # /workflow-commands-for-github-actions#setting-an-output-parameter
        run: >
          echo "::set-output name=current_version::$(
          grep "current_version = " ./.bumpversion.cfg | cut -d ' ' -f 3 )"
      - name: Print version
        run: |
          echo "Current version: ${{ steps.get_version.outputs.current_version }}"
      - name: Hard-code version in workflows
        # This step is only used in the original repository to automate remote URL tagging.
        if: github.repository == 'kdeldycke/workflows'
        # XXX Ideally, this step should have been encoded into .bumpversion.cfg configuration.
        # Default branch is set in a variable as a hack to prevent bumpversion to modify its own invocation.
        run: >
          DEFAULT_BRANCH="main" &&
          bumpversion --verbose --no-configured-files
          --search "/workflows/$DEFAULT_BRANCH/"
          --replace "/workflows/v{current_version}/"
          no-bump
          `grep --files-with-matches "/workflows/$DEFAULT_BRANCH/"
          ./.github/workflows/*.yaml`
      - name: Set release date to today
        run: |
          perl -pi -e "s/\(unreleased\)/\(`date +'%Y-%m-%d'`\)/" ./changelog.md
      - name: Update comparison URL
        run: |
          perl -pi -e "s/\.\.\.main/\.\.\.v${{ steps.get_version.outputs.current_version }}/" ./changelog.md
      - name: Remove first warning message
        # Matches first occurrence of a multi-line block of text delimited by triple-backticks (```<anything>```).
        run: >
          python -c 'import re; from pathlib import Path; file = Path("./changelog.md");
          file.write_text(re.sub(r"^\`\`\`.*?\`\`\`\n\n", "", file.read_text(),
          count=1, flags=re.MULTILINE | re.DOTALL))'
      - uses: peter-evans/create-pull-request@v3.12.0
        with:
          # WORKFLOW_UPDATE_GITHUB_PAT is a custom token created from my user's profile via the
          # "Developer Settings > Personal Access Tokens" UI to allow this job to update its own workflows. This is
          # only used on the original kdeldycke/workflows repository, hence the fallback to default GitHub token.
          token: ${{ secrets.WORKFLOW_UPDATE_GITHUB_PAT || secrets.GITHUB_TOKEN }}
          assignees: ${{ github.actor }}
          commit-message: >
            [changelog] Release v${{ steps.get_version.outputs.current_version }}
          title: >
            Release v${{ steps.get_version.outputs.current_version }}
          body: >
            This PR is ready to be merged. The merge event will trigger[^1] the:


            1. creation of a `v${{ steps.get_version.outputs.current_version }}` tag on [`main`](${{
            github.event.repository.html_url }}/tree/main) branch

            1. publication of a GitHub release

            1. auto-push of a post-release version bump commit


            [^1]: as [defined by `release.yaml`](${{ github.event.repository.html_url }}/blob/${{
            github.sha }}/.github/workflows/release.yaml).


            <details><summary><code>Workflow metadata</code></summary>


            > [Auto-generated on run `#${{ github.run_id }}`](${{ github.event.repository.html_url
            }}/actions/runs/${{ github.run_id }}) by `${{ github.job }}` job from [`changelog.yaml`](${{
            github.event.repository.html_url }}/blob/${{ github.sha }}/.github/workflows/changelog.yaml) workflow.


            </details>
          labels: "ðŸ†™ changelog"
          base: main
          branch: prepare-release
          delete-branch: true
          draft: true
