---
name: Changelog & versions
"on":
  push:
    branches:
      - main
    paths:
      - changelog.md
      - requirements.txt
      - .bumpversion.cfg
      - .github/workflows/*.yaml
  schedule:
    # Run daily so the changelog date in prepare-release job is kept up to date
    - cron: "23 0 * * *"

jobs:

  minor-version-increment:
    # Only let prepare-release job being triggered by schedule event.
    if: ${{ github.event_name != 'schedule' }}
    runs-on: ubuntu-20.04
    steps:
      - uses: actions/checkout@v2.4.0
      - uses: actions/setup-python@v2.2.2
      - name: Install pip
        run: |
          python -m pip install --upgrade pip
      - name: Install bumpversion
        run: >
          python -m pip install --requirement
          https://raw.githubusercontent.com/kdeldycke/workflows/v0.3.3/requirements.txt
      - name: Minor version bump
        run: |
          bumpversion --verbose minor
      - name: Extract new version
        id: get_version
        # Docs: https://docs.github.com/en/actions/learn-github-actions
        # /workflow-commands-for-github-actions#setting-an-output-parameter
        run: >
          echo "::set-output name=NEW_VERSION::$(
          grep "current_version = " ./.bumpversion.cfg | cut -d ' ' -f 3 )"
      - name: Print new version
        run: >
          echo "New version: ${{ steps.get_version.outputs.NEW_VERSION }}"
      - uses: peter-evans/create-pull-request@v3.12.0
        with:
          assignees: ${{ github.actor }}
          commit-message: >
            [changelog] Next release no longer bug-fix only; bump version to
            v${{ steps.get_version.outputs.NEW_VERSION }}.
          title: >
            [changelog] Bump minor version to
            v${{ steps.get_version.outputs.NEW_VERSION }}
          body: >
            Ready to be merged into `main` branch, at the discretion of the
            maintainers, to bump the minor part of the version number.


            [Auto-generated on run `#${{ github.run_id }}`](${{
            github.event.repository.html_url }}/actions/runs/${{ github.run_id
            }}) by `${{ github.job }}` job from [`changelog.yaml`](${{
            github.event.repository.html_url }}/blob/${{ github.sha
            }}/.github/workflows/changelog.yaml) workflow.
          labels: "ðŸ”© CI/CD, ðŸ“— documentation"
          base: main
          branch: minor-version-increment
          delete-branch: true
          draft: true

  major-version-increment:
    # Only let prepare-release job being triggered by schedule event.
    if: ${{ github.event_name != 'schedule' }}
    runs-on: ubuntu-20.04
    steps:
      - uses: actions/checkout@v2.4.0
      - uses: actions/setup-python@v2.2.2
      - name: Install pip
        run: |
          python -m pip install --upgrade pip
      - name: Install bumpversion
        run: >
          python -m pip install --requirement
          https://raw.githubusercontent.com/kdeldycke/workflows/v0.3.3/requirements.txt
      - name: Major version bump
        run: |
          bumpversion --verbose major
      - name: Extract new version
        id: get_version
        # Docs: https://docs.github.com/en/actions/learn-github-actions
        # /workflow-commands-for-github-actions#setting-an-output-parameter
        run: >
          echo "::set-output name=NEW_VERSION::$(
          grep "current_version = " ./.bumpversion.cfg | cut -d ' ' -f 3 )"
      - name: Print new version
        run: >
          echo "New version: ${{ steps.get_version.outputs.NEW_VERSION }}"
      - uses: peter-evans/create-pull-request@v3.12.0
        with:
          assignees: ${{ github.actor }}
          commit-message: >
            [changelog] Next release is major; bump version to
            v${{ steps.get_version.outputs.NEW_VERSION }}.
          title: >
            [changelog] Bump major version to
            v${{ steps.get_version.outputs.NEW_VERSION }}
          body: >
            Ready to be merged into `main` branch, at the discretion of the
            maintainers, to bump the major part of the version number.


            [Auto-generated on run `#${{ github.run_id }}`](${{
            github.event.repository.html_url }}/actions/runs/${{ github.run_id
            }}) by `${{ github.job }}` job from [`changelog.yaml`](${{
            github.event.repository.html_url }}/blob/${{ github.sha
            }}/.github/workflows/changelog.yaml) workflow.
          labels: "ðŸ”© CI/CD, ðŸ“— documentation"
          base: main
          branch: major-version-increment
          delete-branch: true
          draft: true

  prepare-release:
    runs-on: ubuntu-20.04
    steps:
      - uses: actions/checkout@v2.4.0
      - uses: actions/setup-python@v2.2.2
      - name: Install pip
        run: |
          python -m pip install --upgrade pip
      - name: Install bumpversion
        run: >
          python -m pip install --requirement
          https://raw.githubusercontent.com/kdeldycke/workflows/v0.3.3/requirements.txt
      - name: Extract current version
        id: get_version
        # Docs: https://docs.github.com/en/actions/learn-github-actions
        # /workflow-commands-for-github-actions#setting-an-output-parameter
        run: >
          echo "::set-output name=CURRENT_VERSION::$(
          grep "current_version = " ./.bumpversion.cfg | cut -d ' ' -f 3 )"
      - name: Print current version
        run: >
          echo "Current version:
          ${{ steps.get_version.outputs.CURRENT_VERSION }}"
      - name: Hard-code version in workflows
        # Default branch is set in a vaiable as a hack to prevent bumpversion
        # to modify its own invocation.
        run: >
          DEFAULT_BRANCH="main" &&
          bumpversion --verbose --no-configured-files
          --search "/workflows/$DEFAULT_BRANCH/"
          --replace "/workflows/v{current_version}/"
          no-bump
          `grep --files-with-matches "/workflows/$DEFAULT_BRANCH/"
          ./.github/workflows/*.yaml`
      - name: Set release date to today
        run: |
          perl -pi -e "s/\(unreleased\)/\(`date +'%Y-%m-%d'`\)/" ./changelog.md
      - name: Update comparison URL
        run: >
          bumpversion --verbose --no-configured-files
          --search "...main)"
          --replace "...v{current_version})"
          no-bump ./changelog.md
      - name: Remove warning message
        run: perl -i -ne "print if not /\`\`\`/ .. /^$/" ./changelog.md
      - uses: peter-evans/create-pull-request@v3.12.0
        with:
          # Token created from my user's profile via the
          # "Developer Settings > Personal Access Tokens" UI to allow this job
          # to update its own workflows.
          token: ${{ secrets.WORKFLOW_UPDATE_GITHUB_PAT }}
          assignees: ${{ github.actor }}
          commit-message: >
            [changelog] Release
            v${{ steps.get_version.outputs.CURRENT_VERSION }}
          title: >
            [changelog] Release
            v${{ steps.get_version.outputs.CURRENT_VERSION }}
          body: >
            Ready to be merged into `main` branch and then tagged as a new
            release.


            [Auto-generated on run `#${{ github.run_id }}`](${{
            github.event.repository.html_url }}/actions/runs/${{ github.run_id
            }}) by `${{ github.job }}` job from [`changelog.yaml`](${{
            github.event.repository.html_url }}/blob/${{ github.sha
            }}/.github/workflows/changelog.yaml) workflow.
          labels: "ðŸ”© CI/CD, ðŸ“— documentation"
          base: main
          branch: prepare-release
          delete-branch: true
          draft: true

  post-release-version-bump:
    # Only let prepare-release job being triggered by schedule event.
    if: ${{ github.event_name != 'schedule' }}
    runs-on: ubuntu-20.04
    steps:
      - uses: actions/checkout@v2.4.0
      - uses: actions/setup-python@v2.2.2
      - name: Install pip
        run: |
          python -m pip install --upgrade pip
      - name: Install bumpversion
        run: >
          python -m pip install --requirement
          https://raw.githubusercontent.com/kdeldycke/workflows/v0.3.3/requirements.txt
      - name: Extract current version
        id: get_version
        # Docs: https://docs.github.com/en/actions/learn-github-actions
        # /workflow-commands-for-github-actions#setting-an-output-parameter
        run: >
          echo "::set-output name=CURRENT_VERSION::$(
          grep "current_version = " ./.bumpversion.cfg | cut -d ' ' -f 3 )"
      - name: Print current version
        run: >
          echo "Current version:
          ${{ steps.get_version.outputs.CURRENT_VERSION }}"
      - name: Re-target main branch in workflows
        run: >
          DEFAULT_BRANCH="main" &&
          bumpversion --verbose --no-configured-files
          --search "/workflows/v{current_version}/"
          --replace "/workflows/$DEFAULT_BRANCH/"
          no-bump
          `grep --files-with-matches
          "/workflows/v${{ steps.get_version.outputs.CURRENT_VERSION }}/"
          ./.github/workflows/*.yaml`
      - name: Add new changelog entry
        run: >
          python -c "$(curl -fsSL
          https://raw.githubusercontent.com/kdeldycke/workflows/v0.3.3/.github/update_changelog.py)"
      - name: Version bump
        run: |
          bumpversion --verbose patch
      - uses: peter-evans/create-pull-request@v3.12.0
        with:
          # Token created from my user's profile via the
          # "Developer Settings > Personal Access Tokens" UI to allow this job
          # to update its own workflows.
          token: ${{ secrets.WORKFLOW_UPDATE_GITHUB_PAT }}
          assignees: ${{ github.actor }}
          commit-message: "[changelog] Post-release version bump"
          title: "[changelog] Post-release version bump"
          body: >
            Ready to be merged into `main` branch right after a new release has
            been tagged.


            [Auto-generated on run `#${{ github.run_id }}`](${{
            github.event.repository.html_url }}/actions/runs/${{ github.run_id
            }}) by `${{ github.job }}` job from [`changelog.yaml`](${{
            github.event.repository.html_url }}/blob/${{ github.sha
            }}/.github/workflows/changelog.yaml) workflow.
          labels: "ðŸ”© CI/CD, ðŸ“— documentation"
          base: main
          branch: post-release-version-bump
          delete-branch: true
          draft: true
