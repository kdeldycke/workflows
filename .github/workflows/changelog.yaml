---
name: Changelog & versions
"on":
  workflow_call:
  workflow_dispatch:
  schedule:
    # Run daily at 6:00 UTC for bump-versions job.
    - cron: "0 6 * * *"
  push:
    branches:
      - main
    paths:
      - changelog.md
      - "**/pyproject.toml"
      # Trigger on any workflow change to make sure version gets hard-coded everywhere.
      - .github/workflows/*.yaml
  # Trigger after release workflow completes to ensure tags exist before bump-versions.
  # This avoids race conditions where changelog workflow checks for tags before they're pushed.
  workflow_run:
    workflows:
      - "Build & release"
    types:
      - completed
    branches:
      - main

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:

  project-metadata:
    name: Project metadata
    # Run on schedule (daily), manual dispatch, or after release workflow completes successfully.
    if: >
      github.event_name == 'schedule' ||
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')
    runs-on: ubuntu-slim
    outputs:
      # Bump eligibility to prevent double version increments within a development cycle.
      minor_bump_allowed: ${{ steps.project-metadata.outputs.minor_bump_allowed }}
      major_bump_allowed: ${{ steps.project-metadata.outputs.major_bump_allowed }}
    steps:
      - uses: actions/checkout@v6.0.2
        with:
          # For workflow_run, checkout the commit from the triggering workflow.
          ref: ${{ github.event.workflow_run.head_sha || github.sha }}
          # Fetch all tags so we can compare against the latest release.
          fetch-tags: true
      - uses: astral-sh/setup-uv@v7.2.1
      - name: Run gha-utils metadata
        id: project-metadata
        run: |
          uvx --no-progress 'gha-utils==5.6.1' metadata --output "$GITHUB_OUTPUT"

  bump-versions:
    needs:
      - project-metadata
    # Always run since project-metadata already filters appropriate events.
    runs-on: ubuntu-slim
    strategy:
      matrix:
        part:
          - minor
          - major
    # The condition must be repeated on each step because:
    # 1. Job-level `if:` is evaluated before matrix expansion, so `matrix.*` isn't available there
    # 2. GitHub Actions lacks conditional step groups to skip multiple steps with one condition
    steps:
      - uses: actions/checkout@v6.0.2
        if: needs.project-metadata.outputs[format('{0}_bump_allowed', matrix.part)] == 'true'
        with:
          # For workflow_run, checkout the commit from the triggering workflow.
          ref: ${{ github.event.workflow_run.head_sha || github.sha }}
      - uses: astral-sh/setup-uv@v7.2.1
        if: needs.project-metadata.outputs[format('{0}_bump_allowed', matrix.part)] == 'true'
      - name: Install bump-my-version
        if: needs.project-metadata.outputs[format('{0}_bump_allowed', matrix.part)] == 'true'
        run: |
          uv tool install 'bump-my-version==1.2.6'
      - name: ${{ matrix.part }} version bump
        if: needs.project-metadata.outputs[format('{0}_bump_allowed', matrix.part)] == 'true'
        run: |
          bump-my-version bump --verbose ${{ matrix.part }}
      - name: Sync uv.lock
        if: needs.project-metadata.outputs[format('{0}_bump_allowed', matrix.part)] == 'true'
        run: |
          uv --no-progress sync
      - name: Extract version
        if: needs.project-metadata.outputs[format('{0}_bump_allowed', matrix.part)] == 'true'
        id: get_version
        run: |
          echo "new_version=$( bump-my-version show current_version )" | tee -a "$GITHUB_OUTPUT"
      - id: pr-metadata
        if: needs.project-metadata.outputs[format('{0}_bump_allowed', matrix.part)] == 'true'
        uses: kdeldycke/workflows/.github/actions/pr-metadata@main
        with:
          prefix: |
            ### Description

            Ready to be merged into `main` branch, at the discretion of the maintainers, to bump the ${{ matrix.part }}
            part of the version number.

            ### To bump version to v${{ steps.get_version.outputs.new_version }}

            1. **click `Ready for review`** button below, to get this PR out of `Draft` mode

            1. **click `Rebase and merge`** button below

            ---
      - uses: peter-evans/create-pull-request@v8.1.0
        if: needs.project-metadata.outputs[format('{0}_bump_allowed', matrix.part)] == 'true'
        with:
          assignees: ${{ github.actor }}
          commit-message: >
            [changelog] Bump ${{ matrix.part }} version to v${{ steps.get_version.outputs.new_version }}
          title: >
            Bump ${{ matrix.part }} version to `v${{ steps.get_version.outputs.new_version }}`
          body: ${{ steps.pr-metadata.outputs.body }}
          labels: "ðŸ†™ changelog"
          base: main
          branch: ${{ matrix.part }}-version-increment
          delete-branch: true
          draft: always-true

  prepare-release:
    # Skip schedule (exists for bump-versions only) and workflow_run (would double-run
    # on every push to main, since push already triggers this job directly).
    if: github.event_name != 'schedule' && github.event_name != 'workflow_run'
    runs-on: ubuntu-slim
    steps:
      - uses: actions/checkout@v6.0.2
      - uses: astral-sh/setup-uv@v7.2.1
      - name: Install bump-my-version
        run: |
          uv tool install 'bump-my-version==1.2.6'
      - name: Extract version
        id: get_version
        run: |
          echo "current_version=$( bump-my-version show current_version )" | tee -a "$GITHUB_OUTPUT"
      - name: Prepare release
        # Updates changelog and citation dates, comparison URL, and removes warning.
        # Also hard-codes version in workflow URLs for kdeldycke/workflows repository.
        run: >-
          uvx --no-progress 'gha-utils==5.6.1' release-prep
          ${{ github.repository == 'kdeldycke/workflows' && '--update-workflows' || '' }}
      - name: Prepare repository
        run: |
          git config --global user.name "${{ github.actor }}"
          git config --global user.email "${{ github.actor }}@users.noreply.github.com"
          git clean -fd
      - name: Create release commit
        run: |
          git commit --all --message="[changelog] Release v${{ steps.get_version.outputs.current_version }}"
      - name: Re-target main branch in workflows
        # This step is only used in the original repository to automate remote URL tagging.
        if: github.repository == 'kdeldycke/workflows'
        run: |
          uvx --no-progress 'gha-utils==5.6.1' release-prep --post-release --update-workflows
      - name: Add new changelog entry
        run: |
          uvx --no-progress 'gha-utils==5.6.1' changelog ./changelog.md
      - name: Version bump
        run: |
          bump-my-version bump --verbose patch
      - name: Sync uv.lock
        run: |
          uv --no-progress sync
      - name: Commit post-release version bump
        run: |
          git commit --all --message="[changelog] Post-release version bump"
      - id: pr-metadata
        uses: kdeldycke/workflows/.github/actions/pr-metadata@main
        with:
          prefix: |
            ### Description

            This PR is ready to be merged. The merge event will trigger[^1] the:

            1. creation of a `v${{ steps.get_version.outputs.current_version }}` tag on
            [`main`](${{ github.event.repository.html_url }}/tree/main) branch

            1. build and release of the Python package to [PyPI](https://pypi.org)

            1. compilation of the project's binaries with Nuitka (if entry points are defined)

            1. publication of a [GitHub release](${{ github.event.repository.html_url }}/releases)
            with all artifacts above attached

            [^1]: as [defined by `release.yaml`](${{ github.event.repository.html_url
            }}/blob/${{ github.sha }}/.github/workflows/release.yaml).

            ### How-to release v${{ steps.get_version.outputs.current_version }}

            1. **click `Re-run all jobs`** from the [workflow run](${{
            github.event.repository.html_url }}/actions/runs/${{ github.run_id }}),
            to refresh the release date to today

            1. wait for the re-run to complete and check the result in diff view

            1. **click `Ready for review`** button below, to get this PR out of `Draft` mode

            1. **click `Rebase and merge`** button below (do not ~`Squash and merge`~:
            the auto-tagging job needs the 2 distinct commits in this PR)

            ---
      - uses: peter-evans/create-pull-request@v8.1.0
        with:
          # We need custom PAT with workflows permission to hard-code version numbers in URLs in
          # .github/workflows/*.yaml files.
          token: ${{ secrets.WORKFLOW_UPDATE_GITHUB_PAT || secrets.GITHUB_TOKEN }}
          assignees: ${{ github.actor }}
          title: >
            Release `v${{ steps.get_version.outputs.current_version }}`
          body: ${{ steps.pr-metadata.outputs.body }}
          labels: "ðŸ†™ changelog"
          base: main
          branch: prepare-release
          delete-branch: true
          draft: always-true
