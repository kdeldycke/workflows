---
name: ðŸ·ï¸ Labels
"on":
  workflow_call:
  workflow_dispatch:
  push:
    branches:
      - main
  # Trigger labellers and sponsor tagger on PR open only to avoid excessive runs.
  pull_request:
    branches-ignore:
      - prepare-release
      - renovate/**
    types: [opened]
  # Trigger labellers and sponsor tagger on issue open only to avoid excessive runs.
  issues:
    types: [opened]

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: ${{ !startsWith(github.event.head_commit.message, '[changelog] Release') }}

jobs:

  sync-labels:
    name: ðŸ”„ Sync labels
    # Restrict job to the main branch pushes and workflow calls only, as this is a project-management task.
    if: github.event_name == 'push' || github.event_name == 'workflow_call' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-slim
    steps:
      - uses: actions/checkout@v6.0.2
      - uses: astral-sh/setup-uv@v7.3.0
      - name: Install labelmaker
        run: |
          curl -fsSL --output /tmp/lm.tar.xz \
            "https://github.com/jwodder/labelmaker/releases/download/v0.6.4/labelmaker-x86_64-unknown-linux-gnu.tar.xz"
          echo "d76f8e64f9671884dac1758fe54a28a6680c5d9bf0ffd593a2c68ba558cc49a2  /tmp/lm.tar.xz" | sha256sum --check
          mkdir -p /tmp/lm
          tar xJ --strip-components=1 --directory=/tmp/lm --file=/tmp/lm.tar.xz
          mv /tmp/lm/labelmaker /usr/local/bin/labelmaker
      - name: Dump labels
        run: uvx --no-progress --from . repomatic init labels --overwrite
      - name: Apply labels
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        # Multiple file support for labelmaker apply is being discussed upstream at:
        # https://github.com/jwodder/labelmaker/issues/125
        run: |
          # Apply default profile to all repositories.
          labelmaker apply labels.toml --profile default "${{ github.repository }}"

          # Apply awesome profile for awesome-* repositories.
          # shellcheck disable=SC2193 # False positive: shellcheck doesn't understand GitHub expression templating.
          if [[ "${{ github.event.repository.name }}" == "awesome-"* ]] && \
             [[ "${{ github.event.repository.name }}" != "awesome-template" ]]; then
            labelmaker apply labels.toml --profile awesome "${{ github.repository }}"
          fi

          # Apply extra label files.
          for f in extra-labels/*; do
            [ -f "$f" ] || continue
            labelmaker apply "$f" "${{ github.repository }}"
          done

  project-metadata:
    name: ðŸ§¬ Project metadata
    # All jobs depending on project-metadata in this workflow are skipped on prepare-release branch.
    if: github.head_ref != 'prepare-release'
    runs-on: ubuntu-slim
    outputs:
      is_bot: ${{ steps.project-metadata.outputs.is_bot }}
    steps:
      - uses: actions/checkout@v6.0.2
      - uses: astral-sh/setup-uv@v7.3.0
      - name: Run repomatic metadata
        id: project-metadata
        run: uvx --no-progress --from . repomatic metadata --output "$GITHUB_OUTPUT"

  file-labeller:
    name: ðŸ“ File-based PR labeller
    needs:
      - project-metadata
    if: >
      github.event_name == 'pull_request'
      && (! fromJson(needs.project-metadata.outputs.is_bot))
    runs-on: ubuntu-slim
    steps:
      - uses: actions/checkout@v6.0.2
      - uses: astral-sh/setup-uv@v7.3.0
      - name: Dump default rules
        run: uvx --no-progress --from . repomatic init labels --overwrite
      - name: Apply rules
        uses: actions/labeler@v6.0.1
        with:
          configuration-path: ".github/labeller-file-based.yaml"

  content-labeller:
    name: ðŸ“ Content-based labeller
    needs:
      - project-metadata
    if: >
      (github.event_name == 'pull_request' || github.event_name == 'issues')
      && (! fromJson(needs.project-metadata.outputs.is_bot))
    runs-on: ubuntu-slim
    steps:
      - uses: actions/checkout@v6.0.2
      - uses: astral-sh/setup-uv@v7.3.0
      - name: Dump default rules
        run: uvx --no-progress --from . repomatic init labels --overwrite
      - name: Apply rules
        uses: github/issue-labeler@v3.4
        with:
          configuration-path: ".github/labeller-content-based.yaml"
          enable-versioned-regex: 0
          include-title: 1

  sponsor-labeller:
    name: ðŸ’ Tag sponsors
    needs:
      - project-metadata
    if: >
      (github.event_name == 'pull_request' || github.event_name == 'issues')
      && (! fromJson(needs.project-metadata.outputs.is_bot))
    runs-on: ubuntu-slim
    steps:
      - uses: astral-sh/setup-uv@v7.3.0
      - name: Add sponsor label
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: uvx --no-progress --from . repomatic sponsor-label
