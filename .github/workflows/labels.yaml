---
name: Labels
"on":
  workflow_call:
    inputs:
      extra-label-files:
        description: 'Additional label definition files in JSON, JSON5, TOML or YAML'
        required: false
        type: string
      extra-file-rules:
        description: 'YAML describing additional file-based labelling rules'
        required: false
        type: string
      extra-content-rules:
        description: 'YAML describing additional content-based labelling rules'
        required: false
        type: string
  push:
    branches:
      - main
  # Trigger labellers and sponsor tagger on PR open only to avoid excessive runs.
  pull_request:
    types: [opened]
  # Trigger labellers and sponsor tagger on issue open only to avoid excessive runs.
  issues:
    types: [opened]

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: ${{ !startsWith(github.event.head_commit.message, '[changelog] Release') }}

jobs:

  sync-labels:
    name: Sync labels
    # Restrict job to the main branch pushes and workflow calls only, as this is a project-management task.
    if: github.event_name == 'push' || github.event_name == 'workflow_call'
    runs-on: ubuntu-slim
    steps:
      - name: Install labelmaker
        uses: taiki-e/install-action@v2.67.2
        with:
          tool: labelmaker@0.6.4
      - name: Download labels
        run: >
          curl -fsSL --output ./labels.toml
          https://raw.githubusercontent.com/kdeldycke/workflows/main/.github/labels.toml
      - name: Download extra label files
        if: inputs.extra-label-files
        run: |
          echo "${{ inputs.extra-label-files }}" | while IFS= read -r url; do
            if [ -n "$url" ]; then
              filename=$(basename "$url")
              curl -fsSL --output "./$filename" "$url"
            fi
          done
      - name: Apply labels
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        # Multiple file support for labelmaker apply is being discussed upstream at:
        # https://github.com/jwodder/labelmaker/issues/125
        run: |
          # Apply default profile to all repositories.
          labelmaker apply labels.toml --profile default "${{ github.repository }}"

          # Apply awesome profile for awesome-* repositories.
          # shellcheck disable=SC2193 # False positive: shellcheck doesn't understand GitHub expression templating.
          if [[ "${{ github.event.repository.name }}" == "awesome-"* ]] && \
             [[ "${{ github.event.repository.name }}" != "awesome-template" ]]; then
            labelmaker apply labels.toml --profile awesome "${{ github.repository }}"
          fi

          # Apply extra label files if provided.
          if [ -n "${{ inputs.extra-label-files }}" ]; then
            echo "${{ inputs.extra-label-files }}" | while IFS= read -r url; do
              if [ -n "$url" ]; then
                filename=$(basename "$url")
                if [ -f "$filename" ]; then
                  labelmaker apply "$filename" "${{ github.repository }}"
                fi
              fi
            done
          fi

  project-metadata:
    name: Project metadata
    # All jobs depending on project-metadata in this workflow are skipped on prepare-release branch.
    if: github.head_ref != 'prepare-release'
    runs-on: ubuntu-slim
    outputs:
      is_bot: ${{ steps.project-metadata.outputs.is_bot }}
    steps:
      - uses: actions/checkout@v6.0.2
      - uses: astral-sh/setup-uv@v7.2.0
      - name: Run gha-utils metadata
        id: project-metadata
        env:
          GITHUB_CONTEXT: ${{ toJSON(github) }}
        run: |
          uvx 'gha-utils==5.0.1' metadata --overwrite "$GITHUB_OUTPUT"

  file-labeller:
    name: File-based PR labeller
    needs:
      - project-metadata
    if: >
      github.event_name == 'pull_request'
      && (! fromJson(needs.project-metadata.outputs.is_bot))
    runs-on: ubuntu-slim
    steps:
      - uses: actions/checkout@v6.0.2
      - name: Download default rules
        run: >
          curl -fsSL --output ./.github/labeller-file-based.yaml
          https://raw.githubusercontent.com/kdeldycke/workflows/main/.github/labeller-file-based.yaml
      - name: Extend default rules
        if: inputs.extra-file-rules
        run: |
          tee -a ./.github/labeller-file-based.yaml <<-EOF

          ${{ inputs.extra-file-rules }}
          EOF
      - name: Apply rules
        uses: actions/labeler@v6.0.1
        with:
          configuration-path: ".github/labeller-file-based.yaml"

  content-labeller:
    name: Content-based labeller
    needs:
      - project-metadata
    if: >
      (github.event_name == 'pull_request' || github.event_name == 'issues')
      && (! fromJson(needs.project-metadata.outputs.is_bot))
    runs-on: ubuntu-slim
    steps:
      - uses: actions/checkout@v6.0.2
      - name: Download default rules
        run: >
          curl -fsSL --output ./.github/labeller-content-based.yaml
          https://raw.githubusercontent.com/kdeldycke/workflows/main/.github/labeller-content-based.yaml
      - name: Extend default rules
        if: inputs.extra-content-rules
        run: |
          tee -a ./.github/labeller-content-based.yaml <<-EOF

          ${{ inputs.extra-content-rules }}
          EOF
      - name: Apply rules
        uses: github/issue-labeler@v3.4
        with:
          configuration-path: ".github/labeller-content-based.yaml"
          enable-versioned-regex: 0
          include-title: 1

  sponsor-labeller:
    name: Tag sponsors
    needs:
      - project-metadata
    if: >
      (github.event_name == 'pull_request' || github.event_name == 'issues')
      && (! fromJson(needs.project-metadata.outputs.is_bot))
    runs-on: ubuntu-slim
    steps:
      - uses: JasonEtco/is-sponsor-label-action@v2.0.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          label: ðŸ’– sponsors
