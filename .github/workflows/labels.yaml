---
name: Labels
"on":
  workflow_call:
  workflow_dispatch:
  push:
    branches:
      - main
  # Trigger labellers and sponsor tagger on PR open only to avoid excessive runs.
  pull_request:
    types: [opened]
  # Trigger labellers and sponsor tagger on issue open only to avoid excessive runs.
  issues:
    types: [opened]

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: ${{ !startsWith(github.event.head_commit.message, '[changelog] Release') }}

jobs:

  sync-labels:
    name: Sync labels
    # Restrict job to the main branch pushes and workflow calls only, as this is a project-management task.
    if: github.event_name == 'push' || github.event_name == 'workflow_call'
    runs-on: ubuntu-slim
    steps:
      - uses: actions/checkout@v6.0.2
      - uses: astral-sh/setup-uv@v7.2.1
      - name: Install labelmaker
        run: >
          curl -fsSL
          "https://github.com/jwodder/labelmaker/releases/download/v0.6.4/labelmaker-x86_64-unknown-linux-gnu.tar.xz"
          | tar xJ --strip-components=1 --directory=/usr/local/bin
      - name: Dump labels
        run: uvx --no-progress 'gha-utils==5.9.0' bundled export labels.toml
      - name: Download extra label files
        run: uvx --no-progress 'gha-utils==5.9.0' bundled fetch-extra-labels
      - name: Apply labels
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        # Multiple file support for labelmaker apply is being discussed upstream at:
        # https://github.com/jwodder/labelmaker/issues/125
        run: |
          # Apply default profile to all repositories.
          labelmaker apply labels.toml --profile default "${{ github.repository }}"

          # Apply awesome profile for awesome-* repositories.
          # shellcheck disable=SC2193 # False positive: shellcheck doesn't understand GitHub expression templating.
          if [[ "${{ github.event.repository.name }}" == "awesome-"* ]] && \
             [[ "${{ github.event.repository.name }}" != "awesome-template" ]]; then
            labelmaker apply labels.toml --profile awesome "${{ github.repository }}"
          fi

          # Apply extra label files.
          for f in extra-labels/*; do
            [ -f "$f" ] && labelmaker apply "$f" "${{ github.repository }}"
          done

  project-metadata:
    name: Project metadata
    # All jobs depending on project-metadata in this workflow are skipped on prepare-release branch.
    if: github.head_ref != 'prepare-release'
    runs-on: ubuntu-slim
    outputs:
      is_bot: ${{ steps.project-metadata.outputs.is_bot }}
    steps:
      - uses: actions/checkout@v6.0.2
      - uses: astral-sh/setup-uv@v7.2.1
      - name: Run gha-utils metadata
        id: project-metadata
        run: uvx --no-progress 'gha-utils==5.9.0' metadata --output "$GITHUB_OUTPUT"

  file-labeller:
    name: File-based PR labeller
    needs:
      - project-metadata
    if: >
      github.event_name == 'pull_request'
      && (! fromJson(needs.project-metadata.outputs.is_bot))
    runs-on: ubuntu-slim
    steps:
      - uses: actions/checkout@v6.0.2
      - uses: astral-sh/setup-uv@v7.2.1
      - name: Dump default rules
        run: uvx --no-progress 'gha-utils==5.9.0' bundled export labeller-file-based.yaml
      - name: Apply rules
        uses: actions/labeler@v6.0.1
        with:
          configuration-path: ".github/labeller-file-based.yaml"

  content-labeller:
    name: Content-based labeller
    needs:
      - project-metadata
    if: >
      (github.event_name == 'pull_request' || github.event_name == 'issues')
      && (! fromJson(needs.project-metadata.outputs.is_bot))
    runs-on: ubuntu-slim
    steps:
      - uses: actions/checkout@v6.0.2
      - uses: astral-sh/setup-uv@v7.2.1
      - name: Dump default rules
        run: uvx --no-progress 'gha-utils==5.9.0' bundled export labeller-content-based.yaml
      - name: Apply rules
        uses: github/issue-labeler@v3.4
        with:
          configuration-path: ".github/labeller-content-based.yaml"
          enable-versioned-regex: 0
          include-title: 1

  sponsor-labeller:
    name: Tag sponsors
    needs:
      - project-metadata
    if: >
      (github.event_name == 'pull_request' || github.event_name == 'issues')
      && (! fromJson(needs.project-metadata.outputs.is_bot))
    runs-on: ubuntu-slim
    steps:
      - uses: astral-sh/setup-uv@v7.2.1
      - name: Add sponsor label
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: uvx --no-progress 'gha-utils==5.9.0' sponsor-label
