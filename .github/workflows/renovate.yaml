---
name: Renovate
"on":
  workflow_call:
  schedule:
    # Run hourly.
    - cron: "0 * * * *"
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - ".github/workflows/renovate.yaml"
      - "renovate.json5"

concurrency:
  # Group workflow jobs so new commits cancels in-progress execution triggered by previous commits. Source:
  # https://mail.python.org/archives/list/pypa-committers@python.org/thread/PCBCQMJF64JGRBOX7E2EE4YLKHT4DI55/
  # https://docs.github.com/en/actions/writing-workflows/choosing-what-your-workflow-does/control-the-concurrency-of-workflows-and-jobs
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.sha }}
  cancel-in-progress: true

jobs:

  check-dependabot-config:
    name: Check Dependabot configuration
    runs-on: ubuntu-slim
    steps:
      - uses: actions/checkout@v6.0.1
      # Dependabot version updates are configured via .github/dependabot.yaml file.
      # If no file exists, version updates are disabled (Renovate handles this).
      - name: Check Dependabot version updates disabled
        run: |
          if [ -f ".github/dependabot.yaml" ] || [ -f ".github/dependabot.yml" ]; then
            echo "::error::Dependabot version updates are enabled. Remove .github/dependabot.yaml or .github/dependabot.yml and use Renovate instead."
            exit 1
          fi
          echo "✓ Dependabot version updates: disabled (no config file)"
      # Dependabot alerts must be enabled so Renovate can read them via the API.
      # Note: GITHUB_TOKEN cannot access vulnerability alerts API, so we use WORKFLOW_UPDATE_GITHUB_PAT.
      # See: https://github.com/orgs/community/discussions/60612
      - name: Check Dependabot alerts enabled
        env:
          GH_TOKEN: ${{ secrets.WORKFLOW_UPDATE_GITHUB_PAT || secrets.GITHUB_TOKEN }}
        run: |
          if gh api "repos/${{ github.repository }}/vulnerability-alerts" --silent 2>/dev/null; then
            echo "✓ Dependabot alerts: enabled (Renovate can read vulnerabilities)"
          else
            echo "::warning::Cannot verify Dependabot alerts status. Ensure they are enabled in Settings > Advanced Security > Dependabot > Dependabot alerts."
          fi
      # Dependabot security updates must be disabled (Renovate creates security PRs instead).
      - name: Check Dependabot security updates disabled
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          status=$(gh api "repos/${{ github.repository }}" --jq '.security_and_analysis.dependabot_security_updates.status // "disabled"')
          if [ "$status" = "enabled" ]; then
            echo "::error::Dependabot security updates are enabled. Disable them in Settings > Advanced Security > Dependabot > Dependabot security updates."
            exit 1
          fi
          echo "✓ Dependabot security updates: disabled (Renovate handles security PRs)"

  renovate:
    name: Renovate
    needs:
      - check-dependabot-config
    # Cannot use "ubuntu-slim" here because renovatebot/github-action relies on Docker.
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v6.0.1
      - uses: renovatebot/github-action@v44.2.4
        with:
          # We need custom PAT with workflows permission to update GitHub Actions versions in
          # .github/workflows/*.yaml files.
          token: ${{ secrets.WORKFLOW_UPDATE_GITHUB_PAT || secrets.GITHUB_TOKEN }}
        env:
          # Self-hosted configuration.
          RENOVATE_PLATFORM: "github"
          RENOVATE_AUTODISCOVER: "false"
          RENOVATE_REPOSITORIES: ${{ github.repository }}
          # Skip onboarding PR since we already have renovate.json5.
          RENOVATE_ONBOARDING: "false"
          # Require a configuration file to be present.
          RENOVATE_REQUIRE_CONFIG: "required"
          # Fetch all PRs, not just those created by the current bot.
          # Useful for migrating between bot accounts or taking over existing PRs.
          RENOVATE_IGNORE_PR_AUTHOR: "true"
          LOG_LEVEL: "info"
