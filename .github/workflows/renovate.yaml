---
name: Renovate
"on":
  workflow_call:
  schedule:
    # Run weekly.
    - cron: "3 17 * * 1"
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - ".github/workflows/renovate.yaml"
      - "renovate.json5"

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: ${{ !startsWith(github.event.head_commit.message, '[changelog] Release') }}

jobs:

  check-renovate-prereqs:
    name: Check Renovate prerequisites
    runs-on: ubuntu-slim
    steps:
      - uses: actions/checkout@v6.0.2
      # Dependabot version updates are configured via .github/dependabot.yaml file.
      # If no file exists, version updates are disabled (Renovate handles this).
      - name: Check Dependabot version updates disabled
        run: |
          if [ -f ".github/dependabot.yaml" ] || [ -f ".github/dependabot.yml" ]; then
            echo "::error::Dependabot version updates are enabled. Remove .github/dependabot.yaml" \
              "or .github/dependabot.yml and use Renovate instead."
            exit 1
          fi
          echo "✓ Dependabot version updates: disabled (no config file)"
      # Note: We don't verify if Dependabot alerts are enabled because the API endpoint
      # (GET /repos/{owner}/{repo}/vulnerability-alerts) requires "Administration" permission,
      # which is too powerful to grant. Renovate only needs "Dependabot alerts" (read) permission
      # to read alerts - if the feature is disabled, Renovate simply sees zero alerts.
      # Users should manually verify Dependabot alerts are enabled in Settings > Code security.
      # Dependabot security updates must be disabled (Renovate creates security PRs instead).
      - name: Check Dependabot security updates disabled
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          status=$(gh api "repos/${{ github.repository }}" \
            --jq '.security_and_analysis.dependabot_security_updates.status // "disabled"')
          if [ "$status" = "enabled" ]; then
            echo "::error::Dependabot security updates are enabled. Disable them in" \
              "Settings > Advanced Security > Dependabot > Dependabot security updates."
            exit 1
          fi
          echo "✓ Dependabot security updates: disabled (Renovate handles security PRs)"
      # Token must have commit statuses permission for Renovate to set stability-days status checks.
      - name: Check commit statuses permission
        env:
          GH_TOKEN: ${{ secrets.WORKFLOW_UPDATE_GITHUB_PAT || secrets.GITHUB_TOKEN }}
        run: |
          # Try to read commit statuses to verify permission.
          if gh api "repos/${{ github.repository }}/commits/${{ github.sha }}/statuses" --silent 2>/dev/null; then
            echo "✓ Commit statuses: token has access"
          else
            echo "::warning::Cannot verify commit statuses permission." \
              "Ensure the token has 'Commit statuses: Read and Write' permission."
          fi

  renovate:
    name: Renovate
    needs:
      - check-renovate-prereqs
    # Cannot use "ubuntu-slim" here because renovatebot/github-action relies on Docker.
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v6.0.2
      - name: Update exclude-newer date if stale
        # Updates the exclude-newer date in pyproject.toml when it's older than 7 days.
        # Uses a fixed date (not relative) to prevent uv.lock timestamp churn on every sync.
        # Runs before Renovate so changes are picked up in lock file maintenance.
        run: |
          if [ ! -f pyproject.toml ]; then
            echo "No pyproject.toml found, skipping"
            exit 0
          fi

          # Calculate target date: 7 days ago, truncated to midnight UTC.
          target_date=$(date -u -d "7 days ago" +%Y-%m-%d)

          # Extract current date from pyproject.toml (just the YYYY-MM-DD part).
          current_date=$(grep -oP '(?<=exclude-newer = ")[0-9-]+(?=T)' pyproject.toml || echo "")

          echo "Current exclude-newer date: $current_date"
          echo "Target date (7 days ago): $target_date"

          # Update if current date is older than target.
          if [[ -n "$current_date" && "$current_date" < "$target_date" ]]; then
            echo "Date is stale, updating to $target_date"
            sed -i "s/exclude-newer = \"[^\"]*\"/exclude-newer = \"${target_date}T00:00:00Z\"/" pyproject.toml
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add pyproject.toml
            git commit -m "[deps] Update exclude-newer date to $target_date"
            git push
          else
            echo "Date is still fresh, no update needed"
          fi
      - uses: renovatebot/github-action@v44.2.4
        with:
          # Custom PAT required for Renovate to function fully.
          # See readme.md for full list of required permissions.
          token: ${{ secrets.WORKFLOW_UPDATE_GITHUB_PAT || secrets.GITHUB_TOKEN }}
        env:
          # Self-hosted configuration.
          RENOVATE_PLATFORM: "github"
          RENOVATE_AUTODISCOVER: "false"
          RENOVATE_REPOSITORIES: ${{ github.repository }}
          # Skip onboarding PR since we already have renovate.json5.
          RENOVATE_ONBOARDING: "false"
          # Require a configuration file to be present.
          RENOVATE_REQUIRE_CONFIG: "required"
          # Fetch all PRs, not just those created by the current bot.
          # Useful for migrating between bot accounts or taking over existing PRs.
          RENOVATE_IGNORE_PR_AUTHOR: "true"
