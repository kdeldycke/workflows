---
name: Renovate
"on":
  workflow_call:
  schedule:
    # Run weekly.
    - cron: "3 17 * * 1"
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - ".github/workflows/renovate.yaml"
      - "renovate.json5"
      - "gha_utils/data/renovate.json5"

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: ${{ !startsWith(github.event.head_commit.message, '[changelog] Release') }}

jobs:

  sync-bundled-config:
    name: Sync bundled renovate.json5
    # Only runs in the workflows repo where the bundled config lives.
    if: github.repository == 'kdeldycke/workflows'
    runs-on: ubuntu-slim
    steps:
      - uses: actions/checkout@v6.0.2
      - uses: astral-sh/setup-uv@v7.2.1

      - name: Regenerate bundled renovate.json5
        run: |
          uv run --frozen --no-progress gha-utils bundled export renovate.json5 - > gha_utils/data/renovate.json5

      - uses: peter-evans/create-pull-request@v8.1.0
        with:
          assignees: ${{ github.actor }}
          commit-message: "[autofix] Sync bundled renovate.json5"
          title: "[autofix] Sync bundled renovate.json5"
          body: |
            Auto-generated PR to sync `gha_utils/data/renovate.json5` with root `renovate.json5`.

            The bundled file is used when `gha-utils` is installed as a package.
          labels: "ðŸ¤– ci"
          branch: sync-bundled-renovate-config

  migrate-to-renovate:
    name: Migrate to Renovate
    runs-on: ubuntu-slim
    steps:
      - uses: actions/checkout@v6.0.2
      - uses: astral-sh/setup-uv@v7.2.1

      - name: Check Renovate prerequisites
        id: checks
        env:
          GH_TOKEN: ${{ secrets.WORKFLOW_UPDATE_GITHUB_PAT || secrets.GITHUB_TOKEN }}
        run: |
          uvx --no-progress 'gha-utils==5.7.1' check-renovate --format=github --output "$GITHUB_OUTPUT"

      - name: Export renovate.json5 if missing
        if: steps.checks.outputs.renovate_config_exists == 'false'
        run: |
          uvx --no-progress 'gha-utils==5.7.1' bundled export renovate.json5

      - name: Remove Dependabot config if present
        if: steps.checks.outputs.dependabot_config_path != ''
        run: |
          rm -f "${{ steps.checks.outputs.dependabot_config_path }}"

      - uses: peter-evans/create-pull-request@v8.1.0
        with:
          assignees: ${{ github.actor }}
          commit-message: "[deps] Migrate from Dependabot to Renovate"
          title: "[deps] Migrate from Dependabot to Renovate"
          body: ${{ steps.checks.outputs.pr_body }}
          labels: "ðŸ“¦ dependencies"
          branch: migrate-to-renovate

  renovate:
    name: Renovate
    # Cannot use "ubuntu-slim" here because renovatebot/github-action relies on Docker.
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v6.0.2
      - uses: astral-sh/setup-uv@v7.2.1

      # Validate prerequisites before running Renovate.
      # This ensures the repository is properly configured.
      - name: Validate Renovate prerequisites
        env:
          GH_TOKEN: ${{ secrets.WORKFLOW_UPDATE_GITHUB_PAT || secrets.GITHUB_TOKEN }}
        run: |
          uvx --no-progress 'gha-utils==5.7.1' check-renovate

      - name: Update exclude-newer date if stale
        id: update_date
        # Updates the exclude-newer date in pyproject.toml when it's older than 7 days.
        # Uses a fixed date (not relative) to prevent uv.lock timestamp churn on every sync.
        # Runs before Renovate so changes are picked up in lock file maintenance.
        run: |
          uvx --no-progress 'gha-utils==5.7.1' update-exclude-newer --output "$GITHUB_OUTPUT"

      - name: Commit and push if modified
        if: steps.update_date.outputs.modified == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add pyproject.toml
          git commit -m "[deps] Update exclude-newer date"
          git push

      - uses: renovatebot/github-action@v44.2.5
        with:
          # Custom PAT required for Renovate to function fully.
          # See readme.md for full list of required permissions.
          token: ${{ secrets.WORKFLOW_UPDATE_GITHUB_PAT || secrets.GITHUB_TOKEN }}
        env:
          # Self-hosted configuration.
          RENOVATE_PLATFORM: "github"
          RENOVATE_AUTODISCOVER: "false"
          RENOVATE_REPOSITORIES: ${{ github.repository }}
          # Skip onboarding PR since we already have renovate.json5.
          RENOVATE_ONBOARDING: "false"
          # Require a configuration file to be present.
          RENOVATE_REQUIRE_CONFIG: "required"
          # Fetch all PRs, not just those created by the current bot.
          # Useful for migrating between bot accounts or taking over existing PRs.
          RENOVATE_IGNORE_PR_AUTHOR: "true"
