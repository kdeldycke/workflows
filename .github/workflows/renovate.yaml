---
name: ðŸ†• Renovate
"on":
  workflow_call:
    secrets:
      WORKFLOW_UPDATE_GITHUB_PAT:
        required: false
  schedule:
    # Run weekly.
    - cron: "3 17 * * 1"
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - ".github/workflows/renovate.yaml"
      - "renovate.json5"
      - "repomatic/data/renovate.json5"

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: ${{ !startsWith(github.event.head_commit.message, '[changelog] Release') }}

jobs:

  project-metadata:
    name: ðŸ§¬ Project metadata
    runs-on: ubuntu-slim
    outputs:
      is_python_project: ${{ steps.project-metadata.outputs.is_python_project }}
    steps:
      - uses: actions/checkout@v6.0.2
      - uses: astral-sh/setup-uv@v7.3.0
      - name: Run repomatic metadata
        id: project-metadata
        run: uvx --no-progress --from . repomatic metadata --output "$GITHUB_OUTPUT"

  sync-bundled-config:
    name: ðŸ”„ Sync renovate.json5
    # Only runs in the workflows repo where the bundled config lives.
    # Uses `uv run` (not `uvx --from .`) because the source checkout is always
    # available here. These invocations are intentionally outside the
    # freeze/unfreeze cycle â€” downstream repos never call this job.
    if: github.repository == 'kdeldycke/repomatic'
    runs-on: ubuntu-slim
    steps:
      - uses: actions/checkout@v6.0.2
      - uses: astral-sh/setup-uv@v7.3.0

      - name: Regenerate bundled renovate.json5
        run: uv run --frozen --no-progress repomatic init renovate --output-dir repomatic/data --overwrite

      - id: pr-metadata
        run: >
          uv run --frozen --no-progress repomatic pr-body
          --template sync-renovate
          --output "$GITHUB_OUTPUT"

      - uses: peter-evans/create-pull-request@v8.1.0
        with:
          assignees: ${{ github.actor }}
          commit-message: ${{ steps.pr-metadata.outputs.commit_message }}
          title: ${{ steps.pr-metadata.outputs.title }}
          body: ${{ steps.pr-metadata.outputs.body }}
          labels: "ðŸ¤– ci"
          branch: sync-renovate

  migrate-to-renovate:
    name: ðŸšš Migrate to Renovate
    runs-on: ubuntu-slim
    steps:
      - uses: actions/checkout@v6.0.2
      - uses: astral-sh/setup-uv@v7.3.0

      - name: Check Renovate prerequisites
        id: checks
        env:
          GH_TOKEN: ${{ secrets.WORKFLOW_UPDATE_GITHUB_PAT || secrets.GITHUB_TOKEN }}
        run: uvx --no-progress --from . repomatic check-renovate --format=github --output "$GITHUB_OUTPUT"

      - name: Export renovate.json5 if missing
        if: steps.checks.outputs.renovate_config_exists == 'false'
        run: uvx --no-progress --from . repomatic init renovate --overwrite

      - name: Remove Dependabot config if present
        if: steps.checks.outputs.dependabot_config_path != ''
        run: rm -f "${{ steps.checks.outputs.dependabot_config_path }}"

      - uses: peter-evans/create-pull-request@v8.1.0
        with:
          assignees: ${{ github.actor }}
          commit-message: Migrate from Dependabot to Renovate
          title: Migrate from Dependabot to Renovate
          body: ${{ steps.checks.outputs.pr_body }}
          labels: "ðŸ“¦ dependencies"
          branch: migrate-to-renovate

  renovate:
    name: ðŸ†• Renovate
    # Cannot use "ubuntu-slim" here because renovatebot/github-action relies on Docker.
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v6.0.2
      - uses: astral-sh/setup-uv@v7.3.0

      # Validate prerequisites before running Renovate.
      # This ensures the repository is properly configured.
      - name: Validate Renovate prerequisites
        env:
          GH_TOKEN: ${{ secrets.WORKFLOW_UPDATE_GITHUB_PAT || secrets.GITHUB_TOKEN }}
        run: uvx --no-progress --from . repomatic check-renovate

      - uses: renovatebot/github-action@v44.2.6
        with:
          # Custom PAT required for Renovate to function fully.
          # See readme.md for full list of required permissions.
          token: ${{ secrets.WORKFLOW_UPDATE_GITHUB_PAT || secrets.GITHUB_TOKEN }}
        env:
          # Self-hosted configuration.
          RENOVATE_PLATFORM: "github"
          RENOVATE_AUTODISCOVER: "false"
          RENOVATE_REPOSITORIES: ${{ github.repository }}
          # Skip onboarding PR since we already have renovate.json5.
          RENOVATE_ONBOARDING: "false"
          # Require a configuration file to be present.
          RENOVATE_REQUIRE_CONFIG: "required"
          # Fetch all PRs, not just those created by the current bot.
          # Useful for migrating between bot accounts or taking over existing PRs.
          RENOVATE_IGNORE_PR_AUTHOR: "true"
          # Allow postUpgradeTasks commands to run inside the Renovate container.
          # Two command patterns are allowed:
          # 1. Workflow checksum updates: downloads a pinned uv binary from
          #    GitHub Releases, verifies its SHA-256, extracts uvx, then runs
          #    repomatic update-checksums on the upgraded workflow file.
          # 2. uv hash auto-update: when Renovate bumps the uv version in
          #    renovate.json5, downloads the new tarball and uses sed to
          #    replace the old SHA-256 hash inline (no binary execution).
          RENOVATE_ALLOWED_COMMANDS: >-
            ["^bash -c 'curl -fsSL
            https://github\\.com/astral-sh/uv/releases/download/[0-9.]+/uv-x86_64-unknown-linux-gnu\\.tar\\.gz
            --output /tmp/uv\\.tar\\.gz
            && echo [a-f0-9]{64}  /tmp/uv\\.tar\\.gz \\| sha256sum --check
            && tar xzf /tmp/uv\\.tar\\.gz --strip-components=1 -C /tmp
            && /tmp/uvx --no-progress (--from \\. |)repomatic(==\\d[\\d.]*)? update-checksums",
            "^bash -c 'curl -fsSL
            https://github\\.com/astral-sh/uv/releases/download/[0-9.]+/uv-x86_64-unknown-linux-gnu\\.tar\\.gz
            --output /tmp/uv\\.tar\\.gz
            && sed -i .+ renovate\\.json5'$"]
          # Use containerbase to install tools for Renovate's own manager processing.
          RENOVATE_BINARY_SOURCE: "install"
          # Enable debug logging to diagnose postUpgradeTasks and manager issues.
          RENOVATE_LOG_LEVEL: "debug"
          # Prevent python.org API rate limits (HTTP 429) from aborting the
          # entire Renovate run. Without this, a single throttled request to
          # the python-version datasource causes Renovate to skip all PR
          # creation and dashboard updates for the repository.
          RENOVATE_HOST_RULES: '[{"hostType": "python-version", "abortOnError": false}]'

  sync-uv-lock:
    name: â›“ï¸ Sync uv.lock
    needs:
      - project-metadata
    if: fromJSON(needs.project-metadata.outputs.is_python_project)
    runs-on: ubuntu-slim
    steps:
      - uses: actions/checkout@v6.0.2
      - uses: astral-sh/setup-uv@v7.3.0
      - name: Sync uv.lock
        run: uvx --no-progress --from . repomatic sync-uv-lock
      - id: pr-metadata
        run: >
          uvx --no-progress --from . repomatic pr-body
          --template sync-uv-lock
          --output "$GITHUB_OUTPUT"
      - uses: peter-evans/create-pull-request@v8.1.0
        with:
          assignees: ${{ github.actor }}
          commit-message: ${{ steps.pr-metadata.outputs.commit_message }}
          title: ${{ steps.pr-metadata.outputs.title }}
          body: ${{ steps.pr-metadata.outputs.body }}
          labels: "ðŸ“¦ dependencies"
          branch: sync-uv-lock
